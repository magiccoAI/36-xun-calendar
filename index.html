<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026å¹´ Â· æ—¬</title>
    <!-- ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç¡®ä¿è·¯å¾„æ­£ç¡® -->
    <link href="src/output.css" rel="stylesheet">
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600&family=Nunito:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Nunito', 'Noto Serif SC', sans-serif;
            background-color: #fdfdfd;
            color: #333;
            transition: background 0.5s ease;
        }

        /* --- Theme Textures --- */
        /* Common overlay for texture noise */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* 1. Spring (Vitality) - Oil Painting / Watercolor Effect */
        body.theme-spring {
            background-color: #ecfdf5;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(252, 231, 243, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 80% 10%, rgba(209, 250, 229, 0.7) 0%, transparent 30%),
                radial-gradient(circle at 40% 80%, rgba(254, 243, 199, 0.5) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.4'/%3E%3Cpath d='M50,150 Q100,100 150,150 T250,150' stroke='rgba(167, 243, 208, 0.4)' stroke-width='2' fill='none'/%3E%3Cpath d='M-50,350 Q50,300 150,350 T350,350' stroke='rgba(252, 165, 165, 0.2)' stroke-width='20' stroke-linecap='round' fill='none' filter='blur(10px)'/%3E%3C/svg%3E");
            background-size: cover, cover, cover, 600px 600px;
        }
        body.theme-spring .bg-gray-50 { background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); }

        /* 2. Summer (Fresh Vitality) - Mint & Lemon | Watercolor Style */
        body.theme-summer {
            background-color: #f0f9f4;
            color: #1a4d3e;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(255, 249, 196, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(178, 223, 219, 0.4) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cfilter id='water'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.01' numOctaves='3'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='20'/%3E%3CfeGaussianBlur stdDeviation='2'/%3E%3C/filter%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='100' fill='rgba(0, 150, 136, 0.05)' filter='url(%23water)'/%3E%3Cpath d='M300 300 Q 350 200 400 300' stroke='rgba(255, 235, 59, 0.2)' stroke-width='40' filter='blur(10px)'/%3E%3C/svg%3E");
            background-size: cover, cover, cover;
        }
        body.theme-summer .text-gray-800 { color: #1a4d3e; }
        body.theme-summer .text-gray-700 { color: #004d40; }
        body.theme-summer .text-gray-500 { color: #00695c; }
        body.theme-summer .text-gray-400 { color: #4db6ac; }
        body.theme-summer .bg-gray-50 { 
            background-color: rgba(255, 255, 255, 0.85); 
            border: 1px solid rgba(178, 223, 219, 0.3);
            box-shadow: 0 4px 20px rgba(0, 77, 64, 0.05);
        }

        /* 3. Autumn (Warm Steady) - Maple & Parchment | Oil Canvas Style */
        body.theme-autumn {
            background-color: #fff8e1; /* Amber 50 */
            color: #3e2723; /* Dark Brown */
            background-image: 
                linear-gradient(135deg, rgba(255, 243, 224, 0.8) 0%, rgba(255, 255, 255, 0) 100%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='canvas'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3'/%3E%3CfeColorMatrix type='matrix' values='1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.1 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23canvas)'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 20 Q 70 5 80 30 T 60 60' stroke='rgba(230, 81, 0, 0.08)' stroke-width='8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: cover, 200px 200px, 150px 150px;
        }
        body.theme-autumn .text-gray-800 { color: #3e2723; }
        body.theme-autumn .text-gray-700 { color: #4e342e; }
        body.theme-autumn .text-gray-500 { color: #795548; }
        body.theme-autumn .text-gray-400 { color: #a1887f; }
        body.theme-autumn .bg-gray-50 { 
            background-color: rgba(255, 253, 231, 0.9); 
            border: 1px solid rgba(255, 224, 178, 0.4);
            box-shadow: 0 4px 15px rgba(62, 39, 35, 0.05);
        }

        /* 4. Winter (Quiet Deep) - Snow & Ink | Washi/Frosted Style */
        body.theme-winter {
            background-color: #f5f7fa; /* Snow Gray */
            color: #2c3e50; /* Ink Blue */
            background-image: 
                linear-gradient(to bottom, #f5f7fa 0%, #e3e8ee 100%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='washi'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='matrix' values='1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.05 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23washi)' opacity='0.5'/%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='100' cy='100' r='60' fill='rgba(44, 62, 80, 0.03)' filter='blur(20px)'/%3E%3Cpath d='M250,250 Q300,300 350,250' stroke='rgba(38, 50, 56, 0.05)' stroke-width='2' fill='none' filter='blur(2px)'/%3E%3C/svg%3E");
            background-size: cover, 150px 150px, cover;
            background-blend-mode: multiply;
        }
        body.theme-winter .text-gray-800 { color: #2c3e50; }
        body.theme-winter .text-gray-700 { color: #37474f; }
        body.theme-winter .text-gray-500 { color: #546e7a; }
        body.theme-winter .text-gray-400 { color: #607d8b; }
        body.theme-winter .bg-gray-50 { 
            background-color: rgba(255, 255, 255, 0.8); 
            border: 1px solid rgba(207, 216, 220, 0.5);
            box-shadow: 0 4px 20px rgba(38, 50, 56, 0.05);
            backdrop-filter: blur(8px);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* èµ°è·¯åŠ¨ç”» */
        @keyframes walk {
            0% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0); }
        }
        .animate-walk {
            animation: walk 0.6s infinite ease-in-out;
        }
        
        /* è¿›åº¦æ¡çº¹ç† */
        .progress-stripe {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        /* Night Mode Adaptation (Reduces glare) */
        @media (prefers-color-scheme: dark) {
            body.theme-summer { background-color: #dbece4; }
            body.theme-autumn { background-color: #f5e8c8; }
            body.theme-winter { background-color: #cfd8dc; }
            /* Dim the white containers slightly */
            body[class*="theme-"] .bg-gray-50 {
                background-color: rgba(255, 255, 255, 0.6);
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased overflow-x-hidden">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl relative">
        <header class="text-center mb-8 relative">
            <!-- Theme Toggle Button -->
            <div class="absolute right-0 top-0">
                <button id="theme-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors rounded-full hover:bg-white/50" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                </button>
                <!-- Theme Menu -->
                <div id="theme-menu" class="hidden absolute right-0 mt-2 w-32 bg-white rounded-xl shadow-lg border border-gray-100 py-1 z-50 text-xs">
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setTheme('default')">
                        <span class="w-3 h-3 rounded-full bg-gray-100 border border-gray-200"></span> é»˜è®¤ (Default)
                    </button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setTheme('spring')">
                        <span class="w-3 h-3 rounded-full bg-green-100 border border-green-200"></span> æ˜¥ç”Ÿ (Spring)
                    </button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setTheme('summer')">
                        <span class="w-3 h-3 rounded-full bg-blue-100 border border-blue-200"></span> å¤é•¿ (Summer)
                    </button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setTheme('autumn')">
                        <span class="w-3 h-3 rounded-full bg-orange-100 border border-orange-200"></span> ç§‹æ”¶ (Autumn)
                    </button>
                    <button class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setTheme('winter')">
                        <span class="w-3 h-3 rounded-full bg-gray-200 border border-gray-300"></span> å†¬è— (Winter)
                    </button>
                </div>
            </div>

            <h1 class="text-3xl font-light text-gray-700">2026</h1>
            <p id="current-xun-info" class="text-gray-500 mt-2"></p>
            <div id="year-progress-container" class="mt-6 max-w-2xl mx-auto px-4">
                <div class="flex items-center gap-3 text-xs text-gray-400 font-mono">
                    <span class="min-w-[48px] text-left">1æœˆ1æ—¥</span>
                    <div class="relative flex-1 h-4 bg-gray-100 rounded-full shadow-inner overflow-visible">
                        <div id="year-progress-bar" class="absolute left-0 top-0 h-full bg-blue-500 rounded-full transition-all duration-1000 shadow-md progress-stripe overflow-hidden" style="width: 0%"></div>
                        <div id="year-progress-walker" class="absolute bottom-full translate-y-1 transition-all duration-1000 z-10" style="left: 0%">
                            <div class="animate-walk -ml-3">
                                <svg width="24" height="32" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-md">
                                    <circle cx="12" cy="6" r="4" fill="#2563EB"/>
                                    <path d="M12 10V20M12 20L8 30M12 20L16 30M12 13L7 16M12 13L17 16" stroke="#2563EB" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div id="walker-bubble" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[10px] px-2 py-0.5 rounded opacity-0 transition-opacity duration-300 whitespace-nowrap pointer-events-none">
                                Today
                            </div>
                        </div>
                    </div>
                    <span class="min-w-[48px] text-right">12æœˆ31æ—¥</span>
                </div>
                <div class="mt-2 text-center text-xs font-mono">
                    <span id="year-progress-text" class="font-bold text-blue-600"></span>
                </div>
            </div>

            <!-- å¹´åº¦åƒç´ æ€»è§ˆ (Tetris/Pixel Grid) -->
            <div id="year-pixel-grid-container" class="mt-8 max-w-4xl mx-auto px-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-medium text-gray-500">2026 å¹´åº¦è¶³è¿¹ï¼ˆæ—¶é—´è¿›åº¦ï¼‰</h3>
                    <div class="flex gap-2 text-[10px] text-gray-400">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-gray-100 border border-gray-200"></span> æœªæ¥</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-blue-100 border border-blue-200"></span> è¿‡å»</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-blue-500 border border-blue-600 shadow-sm animate-pulse"></span> ä»Šå¤©</span>
                    </div>
                </div>
                <p class="text-[11px] text-gray-400 mb-3">ä»…å±•ç¤ºå…¨å¹´æ—¶é—´ä½ç½®ï¼Œä¸ä»£è¡¨è®°å½•å¼ºåº¦ï¼›è¯¦ç»†è®°å½•è¯·çœ‹ä¸‹æ–¹å…¨æ™¯æ¦‚è§ˆã€‚</p>
                <div id="year-pixel-grid" class="flex flex-wrap gap-[2px] justify-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                    <!-- JS ç”Ÿæˆ 365 ä¸ªæ ¼å­ -->
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6 border-b border-gray-200">
            <button id="nav-macro" class="px-6 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none">
                36æ—¬ (36-Xun)
            </button>
            <button id="nav-overview" class="px-6 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none">
                å…¨æ™¯ & æ—¬ (Overview & Xun)
            </button>
        </div>

        <!-- View Container -->
        <div class="relative w-full">
            <!-- View M: Macro Planning View (New Default) -->
            <div id="macro-view" class="w-full relative">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="hidden md:grid grid-cols-12 gap-0 text-sm font-medium text-gray-500 bg-gray-50 border-b border-gray-200 p-3">
                        <div class="col-span-1 text-center">æ—¬</div>
                        <div class="col-span-2 text-center">æ—¥æœŸ</div>
                        <div class="col-span-4 pl-2">æ ¸å¿ƒç›®æ ‡</div>
                        <div class="col-span-3 text-center">æ¯æ—¥æ‰“å¡</div>
                        <div class="col-span-2 text-center">å¤‡æ³¨</div>
                    </div>
                    <div id="macro-list" class="divide-y divide-gray-100">
                        <!-- JS Generated Rows -->
                    </div>
                </div>

            </div>

            <!-- View A: Overview & Detail Combined -->
            <div id="overview-view" class="w-full hidden">
                <!-- Overview Grid -->
    <div class="mb-8">
        <div id="overview-grid" class="grid-container">
            <!-- Xun blocks will be generated by JS -->
        </div>
    </div>

    <!-- Detail View Section (Now embedded) -->
    <div id="detail-section" class="w-full bg-gray-50 min-h-[600px] rounded-xl border border-gray-100 overflow-hidden relative">
        <div id="detail-content" class="hidden">
                        <div class="flex justify-between items-center p-4 bg-white border-b border-gray-100 gap-2 md:gap-4">
                            <div class="flex items-center gap-1">
                                <button onclick="window.goToMacro()" class="p-2 text-gray-500 hover:text-blue-600 transition-colors rounded-full hover:bg-gray-100" title="è¿”å›36æ—¬">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                    </svg>
                                </button>
                                <!-- Back to Grid Button (Removed as per user request) -->
                            </div>
                            <h2 id="detail-title" class="text-xl font-light text-gray-800 flex-1"></h2>
                            <button id="show-summary-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 shadow-sm transition-colors whitespace-nowrap">
                                æœ¬æ—¬å°ç»“
                            </button>
                        </div>
                        <div id="detail-calendars-container" class="space-y-6 md:space-y-8 p-2 md:p-6"></div>
                    </div>
                </div>
            </div>

            <!-- View B: Detail View (Removed/Merged into Overview) -->
            <!-- <div id="detail-view" class="hidden ..."> ... </div> -->
            
            <!-- View C: Summary View -->
            <div id="summary-view" class="hidden w-full bg-gray-50 min-h-[600px]">
                 <div class="flex justify-between items-center mb-4">
                    <button id="back-to-detail" class="text-blue-500 hover:underline">&larr; è¿”å›æ—¥å†</button>
                </div>
                <h2 id="summary-title" class="text-2xl font-light text-center mb-4"></h2>
                <div id="summary-content" class="bg-white p-6 rounded-lg shadow-sm">
                    <!-- Summary charts and stats will go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Scroll Controls -->
    <div id="macro-back-to-top-container" style="position: fixed; bottom: 1rem; right: 1rem; z-index: 50;" class="transition-opacity duration-300 opacity-0 pointer-events-none" aria-hidden="true">
        <button id="macro-back-to-top" type="button" tabindex="-1" class="p-2 md:p-1.5 bg-white/90 backdrop-blur-sm border border-gray-200 rounded-full shadow-lg text-blue-600 hover:bg-blue-50 active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2" aria-label="è¿”å›é¡¶éƒ¨" title="è¿”å›é¡¶éƒ¨">
            <span class="sr-only">è¿”å›é¡¶éƒ¨</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-3.5 md:w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
            </svg>
        </button>
    </div>

    <div id="macro-scroll-down-container" style="position: fixed; bottom: 1rem; left: 1rem; z-index: 50;" class="transition-opacity duration-300 opacity-0 pointer-events-none" aria-hidden="true">
        <button id="macro-scroll-down" type="button" tabindex="-1" class="p-2 md:p-1.5 bg-white/90 backdrop-blur-sm border border-gray-200 rounded-full shadow-lg text-blue-600 hover:bg-blue-50 active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2" aria-label="å¿«é€Ÿä¸‹æ»‘åˆ°ä¸‹ä¸€æ—¬" title="å¿«é€Ÿä¸‹æ»‘åˆ°ä¸‹ä¸€æ—¬">
            <span class="sr-only">å¿«é€Ÿä¸‹æ»‘åˆ°ä¸‹ä¸€æ—¬</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-3.5 md:w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
            </svg>
        </button>
    </div>

    <!-- Modal for Rich Data Entry -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div id="modal-panel" class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto p-4 md:p-6 transform transition-transform duration-300 ease-in-out scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg md:text-xl font-semibold text-gray-800">è®°å½• <span id="modal-date" class="font-mono text-blue-600"></span></h3>
                <button id="modal-close" class="text-gray-400 hover:text-gray-700 text-4xl md:text-5xl leading-none w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full hover:bg-gray-100 transition-all focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="å…³é—­">&times;</button>
            </div>

            <!-- Core Section -->
            <div class="space-y-6">
                <!-- Mood Section Redesign -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»Šæ—¥æ•´ä½“æ„Ÿå— (Daily Mood Tone)</label>
                    <p class="text-[10px] text-gray-400 mb-3">æ— éœ€çº ç»“æ¯æ—¶æ¯åˆ»ï¼Œåªéœ€è®°å½•è¿™ä¸€å¤©ç•™ç»™ä½ æœ€æ·±çš„å°è®°ã€‚</p>
                    <div id="mood-selector" class="flex justify-between items-center gap-1 md:gap-2">
                        <button data-mood="1" class="mood-btn flex flex-col items-center gap-1 p-1 md:p-2 rounded-xl hover:bg-red-50 transition-all focus:outline-none focus:ring-2 focus:ring-red-200" aria-label="ç³Ÿç³•">
                            <span class="text-3xl md:text-4xl filter grayscale hover:grayscale-0 transition-all">ğŸ˜«</span>
                            <span class="text-[10px] md:text-xs text-gray-500 font-medium">ç³Ÿç³•</span>
                        </button>
                        <button data-mood="2" class="mood-btn flex flex-col items-center gap-1 p-1 md:p-2 rounded-xl hover:bg-orange-50 transition-all focus:outline-none focus:ring-2 focus:ring-orange-200" aria-label="ä½è½">
                            <span class="text-3xl md:text-4xl filter grayscale hover:grayscale-0 transition-all">ğŸ˜</span>
                            <span class="text-[10px] md:text-xs text-gray-500 font-medium">ä½è½</span>
                        </button>
                        <button data-mood="3" class="mood-btn flex flex-col items-center gap-1 p-1 md:p-2 rounded-xl hover:bg-gray-50 transition-all focus:outline-none focus:ring-2 focus:ring-gray-200" aria-label="å¹³æ·¡">
                            <span class="text-3xl md:text-4xl filter grayscale hover:grayscale-0 transition-all">ğŸ˜</span>
                            <span class="text-[10px] md:text-xs text-gray-500 font-medium">å¹³æ·¡</span>
                        </button>
                        <button data-mood="4" class="mood-btn flex flex-col items-center gap-1 p-1 md:p-2 rounded-xl hover:bg-blue-50 transition-all focus:outline-none focus:ring-2 focus:ring-blue-200" aria-label="ä¸é”™">
                            <span class="text-3xl md:text-4xl filter grayscale hover:grayscale-0 transition-all">ğŸ™‚</span>
                            <span class="text-[10px] md:text-xs text-gray-500 font-medium">ä¸é”™</span>
                        </button>
                        <button data-mood="5" class="mood-btn flex flex-col items-center gap-1 p-1 md:p-2 rounded-xl hover:bg-green-50 transition-all focus:outline-none focus:ring-2 focus:ring-green-200" aria-label="è¶…æ£’">
                            <span class="text-3xl md:text-4xl filter grayscale hover:grayscale-0 transition-all">ğŸ¤©</span>
                            <span class="text-[10px] md:text-xs text-gray-500 font-medium">è¶…æ£’</span>
                        </button>
                    </div>
                </div>

                <!-- Detailed Emotions Tags -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">æƒ…ç»ªæ ‡ç­¾ (Feelings)</label>
                    <div id="emotion-tags" class="flex flex-wrap gap-2">
                        <!-- Tags will be generated by JS -->
                    </div>
                </div>

                <!-- Daily Quote Section -->
                <div id="daily-quote-container" class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 text-center relative overflow-hidden group">
                     <div class="absolute top-0 left-0 w-1 h-full bg-blue-400"></div>
                     <p id="daily-quote-text" class="text-sm text-gray-600 font-serif italic mb-1 min-h-[1.5em]">æ­£åœ¨åŠ è½½ä»Šæ—¥é‡‘å¥...</p>
                     <p id="daily-quote-author" class="text-xs text-gray-400 text-right">â€”â€” ä½šå</p>
                     <button id="refresh-quote" class="absolute top-2 right-2 text-gray-300 hover:text-blue-500 transition-colors opacity-100 sm:opacity-0 sm:group-hover:opacity-100" title="åˆ·æ–°">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                     </button>
                </div>

                <!-- Keywords Input (Replaces Emoji) -->
                <div>
                    <label for="keywords-input" class="block text-sm font-medium text-gray-700 mb-2">ä»Šæ—¥å…³é”®è¯ (Keywords)</label>
                    <input type="text" id="keywords-input" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="ä¾‹å¦‚: å¥èº«, Reading, Carpe Diem (æœ€å¤š3ä¸ª)">
                    <p class="text-xs text-gray-400 mt-1">å°†åœ¨æ—¥å†æ ¼å­ä¸­å¾®ç¼©æ˜¾ç¤ºï¼Œä»£æ›¿é€šç”¨å›¾æ ‡</p>
                </div>
                <div class="border border-gray-100 rounded-xl p-3 bg-gray-50/40">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-gray-600">æœ¬æ—¬ä¹ æƒ¯æ‰“å¡ (Micro Habits)</span>
                        <span class="text-[10px] text-gray-400">åšæŒå¾®å°æ”¹å˜</span>
                    </div>
                    
                    <!-- Only show in Xun view (hidden by default, JS toggles visibility) -->
                    <div id="xun-goal-container" class="hidden mt-2 mb-2">
                         <label for="xun-goal-input" class="block text-[10px] font-medium text-gray-500 mb-1">å½“å‰æ—¬ç›®æ ‡</label>
                         <div id="xun-goal-display" class="text-xs text-gray-700 italic bg-white p-2 rounded border border-gray-100"></div>
                         <input type="hidden" id="xun-goal-input">
                    </div>

                    <div class="mt-2 space-y-2 hidden">
                        <!-- Hidden inputs for defining habits - they should be defined in Macro View, but kept here for compatibility if needed or removed if we move definition elsewhere. 
                             For now, let's keep them but maybe hide them if we want "minimalist"? 
                             Actually, user might want to EDIT them here. Let's keep them visible but simplified. 
                             Wait, user wants MINIMALIST. Let's hide the DEFINITION inputs if they are already defined?
                             Let's just keep the CHECKBOXES prominent. 
                             Let's keep the inputs but make them look like "settings" or just simplified.
                        -->
                        <input type="text" id="xun-indicator-1" class="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="ä¹ æƒ¯1">
                        <input type="text" id="xun-indicator-2" class="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="ä¹ æƒ¯2">
                        <input type="text" id="xun-indicator-3" class="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="ä¹ æƒ¯3">
                    </div>
                    
                    <!-- Simplified Habits Definition (Collapsible or just simpler) -->
                    <details class="mb-3">
                        <summary class="text-[10px] text-gray-400 cursor-pointer hover:text-blue-500">ç¼–è¾‘ä¹ æƒ¯å†…å®¹</summary>
                         <div class="mt-2 space-y-2">
                                <input type="text" id="xun-indicator-1" class="w-full p-2 border border-gray-200 rounded-md text-xs bg-white" placeholder="ä¹ æƒ¯1ï¼šä¾‹å¦‚ æ¯å¤©é˜…è¯»">
                                <input type="text" id="xun-indicator-2" class="w-full p-2 border border-gray-200 rounded-md text-xs bg-white" placeholder="ä¹ æƒ¯2ï¼šä¾‹å¦‚ å†¥æƒ³ 10åˆ†é’Ÿ">
                                <input type="text" id="xun-indicator-3" class="w-full p-2 border border-gray-200 rounded-md text-xs bg-white" placeholder="ä¹ æƒ¯3ï¼šä¾‹å¦‚ ä¸å–å«ç³–é¥®æ–™">
                        </div>
                    </details>

                    <div class="grid grid-cols-1 gap-2" id="day-indicator-container">
                        <label id="day-indicator-row-1" class="flex items-center justify-between gap-3 text-xs text-gray-600 bg-white p-2 rounded border border-gray-100 shadow-sm">
                            <span id="day-indicator-label-1" class="truncate font-medium">ä¹ æƒ¯1</span>
                            <input type="checkbox" id="day-indicator-check-1" class="h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>
                        <label id="day-indicator-row-2" class="flex items-center justify-between gap-3 text-xs text-gray-600 bg-white p-2 rounded border border-gray-100 shadow-sm">
                            <span id="day-indicator-label-2" class="truncate font-medium">ä¹ æƒ¯2</span>
                            <input type="checkbox" id="day-indicator-check-2" class="h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>
                        <label id="day-indicator-row-3" class="flex items-center justify-between gap-3 text-xs text-gray-600 bg-white p-2 rounded border border-gray-100 shadow-sm">
                            <span id="day-indicator-label-3" class="truncate font-medium">ä¹ æƒ¯3</span>
                            <input type="checkbox" id="day-indicator-check-3" class="h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¤©æ°”</label>
                    <div id="weather-selector" class="flex flex-wrap gap-2 text-2xl">
                        <button data-weather="Sunny" class="p-2 rounded-full hover:bg-gray-200" title="æ™´">â˜€ï¸</button>
                        <button data-weather="Cloudy" class="p-2 rounded-full hover:bg-gray-200" title="å¤šäº‘">â˜ï¸</button>
                        <button data-weather="Overcast" class="p-2 rounded-full hover:bg-gray-200" title="é˜´">ğŸŒ¥ï¸</button>
                        <button data-weather="Rainy" class="p-2 rounded-full hover:bg-gray-200" title="é›¨">ğŸŒ§ï¸</button>
                        <button data-weather="Snowy" class="p-2 rounded-full hover:bg-gray-200" title="é›ª">â„ï¸</button>
                        <button data-weather="Windy" class="p-2 rounded-full hover:bg-gray-200" title="å¤§é£">ğŸŒ¬ï¸</button>
                        <button data-weather="Foggy" class="p-2 rounded-full hover:bg-gray-200" title="é›¾">ğŸŒ«ï¸</button>
                        <button data-weather="Thunder" class="p-2 rounded-full hover:bg-gray-200" title="é›·æš´">âš¡</button>
                    </div>
                </div>
            </div>

            <!-- Vitality Section (New) -->
            <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold text-gray-600 mb-3">èº«å¿ƒçŠ¶æ€ (Vitality)</h4>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-600 mb-1">ä»Šæ—¥èƒ½é‡å€¼ (Energy Level)</label>
                    <input type="range" id="energy-level" min="0" max="100" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>ğŸŒ± ç–²æƒ« (Recharge)</span>
                        <span>âš¡ æ´»åŠ› (Flow)</span>
                    </div>
                </div>
            </div>

            <!-- Nourishment Section (Renamed from Metrics) -->
            <div class="mt-4 border-t pt-4 space-y-3">
                <h4 class="font-semibold text-gray-600">ç”Ÿæ´»æ»‹å…» (Nourishment)</h4>
                
                <!-- Tag Cloud (New) -->
                <div class="flex flex-wrap gap-2 mb-2" id="nourishment-tags-container">
                    <!-- Tags will be generated by JS -->
                </div>

                <!-- Detailed Metrics (Simplified) -->
                <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-md">
                    <div class="flex items-center justify-between">
                        <label for="metric-sleep" class="text-xs text-gray-500">ç¡çœ  (h)</label>
                        <input type="number" id="metric-sleep" step="0.5" class="w-16 p-1 border rounded text-xs bg-white">
                    </div>
                     <div class="flex items-center justify-between">
                        <label for="metric-exercise" class="text-xs text-gray-500">è¿åŠ¨ (min)</label>
                        <input type="number" id="metric-exercise" class="w-16 p-1 border rounded text-xs bg-white">
                    </div>
                     <div class="flex items-center justify-between">
                        <label for="metric-reading" class="text-xs text-gray-500">é˜…è¯» (min)</label>
                        <input type="number" id="metric-reading" class="w-16 p-1 border rounded text-xs bg-white">
                    </div>
                     <div class="flex items-center justify-between">
                        <label for="metric-wealth" class="text-xs text-gray-500">è´¢å¯Œ (+/-)</label>
                        <input type="number" id="metric-wealth" step="0.01" class="w-16 p-1 border rounded text-xs bg-white">
                    </div>
                     <div class="flex items-center justify-between col-span-2">
                        <label for="metric-social" class="text-xs text-gray-500">ç¤¾äº¤/å¤‡æ³¨</label>
                        <input type="text" id="metric-social" class="w-full ml-2 p-1 border rounded text-xs bg-white" placeholder="å’Œæœ‹å‹èšé¤...">
                    </div>
                </div>
            </div>

            <!-- Evening Resonance (Three Good Things) -->
            <div class="mt-6 border-t pt-4">
                 <h4 class="font-semibold text-gray-600 mb-2">âœ¨ ä»Šæ—¥ä¸‰ä»¶å¥½äº‹ (Three Good Things)</h4>
                 <div class="space-y-2">
                     <input type="text" id="good-thing-1" class="w-full p-2 border border-orange-100 bg-orange-50/50 rounded-md text-sm focus:bg-white focus:ring-1 focus:ring-orange-200 transition-colors" placeholder="1. å€¼å¾—æ„Ÿæ©çš„å°äº‹...">
                     <input type="text" id="good-thing-2" class="w-full p-2 border border-orange-100 bg-orange-50/50 rounded-md text-sm focus:bg-white focus:ring-1 focus:ring-orange-200 transition-colors" placeholder="2. ä»Šå¤©çš„é«˜å…‰æ—¶åˆ»...">
                     <input type="text" id="good-thing-3" class="w-full p-2 border border-orange-100 bg-orange-50/50 rounded-md text-sm focus:bg-white focus:ring-1 focus:ring-orange-200 transition-colors" placeholder="3. æˆ‘åšå¾—å¾ˆæ£’çš„äº‹...">
                 </div>
            </div>
            
            <!-- Custom Activities Section -->
            <div id="custom-activities-container" class="mt-6 border-t pt-4 space-y-2">
                 <h4 class="font-semibold text-gray-600">è‡ªå®šä¹‰æ´»åŠ¨</h4>
                 <button id="add-custom-activity" class="text-sm text-blue-500 hover:underline">+ æ·»åŠ æ´»åŠ¨</button>
            </div>

            <!-- Journal Section -->
            <div class="mt-6 border-t pt-4">
                <label for="journal-input" class="block text-sm font-medium text-gray-700 mb-2">ç»™æ˜å¤©çš„å¯å‘</label>
                <textarea id="journal-input" rows="3" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>

            <!-- Actions -->
            <div class="mt-6 flex justify-end space-x-2">
                <button id="modal-delete" class="px-4 py-2 text-sm text-red-500 hover:underline">åˆ é™¤æœ¬æ—¥è®°å½•</button>
                <button id="modal-save" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="src/quote.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const YEAR = 2026;
            const XUN_COUNT = 36;
            const XUN_DAYS = 10;

            // --- DOM Elements ---
            const overviewView = document.getElementById('overview-view');
            // const detailView = document.getElementById('detail-view'); // Removed
            const summaryView = document.getElementById('summary-view');
            const macroView = document.getElementById('macro-view');
            const overviewGrid = document.getElementById('overview-grid');
            const macroList = document.getElementById('macro-list');
            const navMacro = document.getElementById('nav-macro');
            const navOverview = document.getElementById('nav-overview');
            const modal = document.getElementById('modal');
            const modalPanel = document.getElementById('modal-panel');
            
            // New DOM Elements for merged view
            const detailSection = document.getElementById('detail-section');
            // const detailPlaceholder = document.getElementById('detail-placeholder'); // Removed
            const detailContent = document.getElementById('detail-content');

            // --- State ---
            let userData = JSON.parse(localStorage.getItem('xun_calendar_data_v2') || '{}');
            let macroGoals = JSON.parse(localStorage.getItem('xun_macro_goals') || '{}');
            // Custom Emotions
            let customEmotions = JSON.parse(localStorage.getItem('xun_custom_emotions') || '[]');
            const defaultEmotions = [
                { text: 'ğŸ˜„ å¿«ä¹', value: 'å¿«ä¹' },
                { text: 'ğŸ˜† å…´å¥‹', value: 'å…´å¥‹' },
                { text: 'ğŸ™ æ„Ÿæ¿€', value: 'æ„Ÿæ¿€' },
                { text: 'ğŸŒŸ æœŸå¾…', value: 'æœŸå¾…' },
                { text: 'ğŸ¦ è‡ªè±ª', value: 'è‡ªè±ª' },
                { text: 'ğŸ’ª å……å®', value: 'å……å®' },
                { text: 'ğŸ˜Œ å¹³é™', value: 'å¹³é™' },
                { text: 'ğŸ§  ä¸“æ³¨', value: 'ä¸“æ³¨' },
                { text: 'ğŸ˜¶â€ğŸŒ«ï¸ è¿·èŒ«', value: 'è¿·èŒ«' },
                { text: 'ğŸ˜° ç„¦è™‘', value: 'ç„¦è™‘' },
                { text: 'ğŸ˜« ç–²æƒ«', value: 'ç–²æƒ«' },
                { text: 'ğŸ˜  ç”Ÿæ°”', value: 'ç”Ÿæ°”' },
                { text: 'ğŸ‚ å­¤ç‹¬', value: 'å­¤ç‹¬' },
                { text: 'ğŸ˜ å¤±è½', value: 'å¤±è½' }
            ];

            // Custom Nourishments
            let customNourishments = JSON.parse(localStorage.getItem('xun_custom_nourishments') || '[]');
            const defaultNourishments = [
                { text: 'ğŸ“š é˜…è¯»', value: 'é˜…è¯»' },
                { text: 'ğŸ§˜ å†¥æƒ³', value: 'å†¥æƒ³' },
                { text: 'ğŸƒ è¿åŠ¨', value: 'è¿åŠ¨' },
                { text: 'ğŸ¥— å¥åº·é¥®é£Ÿ', value: 'å¥åº·é¥®é£Ÿ' },
                { text: 'ğŸŒ² å¤§è‡ªç„¶', value: 'å¤§è‡ªç„¶' },
                { text: 'â˜• ç¤¾äº¤', value: 'ç¤¾äº¤' },
                { text: 'ğŸ¨ åˆ›ä½œ', value: 'åˆ›ä½œ' }
            ];

            let currentXun = null;
            let xunPeriods = [];
            let selectedDate = '';
            let currentDetailPeriod = null;

            const pad2 = (n) => String(n).padStart(2, '0');
            const formatLocalDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
            const addDaysToDateStr = (dateStr, days) => {
                const d = new Date(`${dateStr}T00:00:00`);
                d.setDate(d.getDate() + days);
                return formatLocalDate(d);
            };

            const migrateUserDataToLocalDates = (data) => {
                const migrationKey = 'xun_calendar_data_v2_local_date_migrated_v1';
                if (localStorage.getItem(migrationKey) === '1') return data;

                const timezoneOffsetMinutes = new Date().getTimezoneOffset();
                if (timezoneOffsetMinutes >= 0 || !data || typeof data !== 'object') {
                    localStorage.setItem(migrationKey, '1');
                    return data;
                }

                const entries = Object.entries(data);
                if (entries.length === 0) {
                    localStorage.setItem(migrationKey, '1');
                    return data;
                }

                const migrated = {};
                for (const [key, value] of entries) {
                    const isDateKey = /^\d{4}-\d{2}-\d{2}$/.test(key);
                    const newKey = isDateKey ? addDaysToDateStr(key, 1) : key;
                    if (migrated[newKey] && value && typeof value === 'object') {
                        migrated[newKey] = { ...migrated[newKey], ...value };
                    } else {
                        migrated[newKey] = value;
                    }
                }

                localStorage.setItem('xun_calendar_data_v2', JSON.stringify(migrated));
                localStorage.setItem(migrationKey, '1');
                return migrated;
            };

            userData = migrateUserDataToLocalDates(userData);

            // --- Core Logic ---
            window.getXunPeriods = function(year) {
                const periods = [];
                let currentDate = new Date(year, 0, 1);
                for (let i = 1; i <= XUN_COUNT; i++) {
                    const startDate = new Date(currentDate);
                    // Last xun (36) has 5 days in non-leap year (365 days), or 6?
                    // 35 * 10 = 350. Remaining = 15.
                    // Actually standard Xun is 10 days.
                    // 36 xuns covers 360 days? No.
                    // Usually: Early (10), Middle (10), Late (remaining).
                    // But here we are strictly "36 multiple 10".
                    // Let's stick to the prompt's 36 * 10 concept but fit into 365 days.
                    // The prompt says "36ä¸ª10å¤©". 36*10 = 360.
                    // The last 5 days (Dec 27-31) are usually part of the 36th period or just appended?
                    // Let's make 1-35 as 10 days, and 36 as 15/16 days to cover the year?
                    // Or 36 as 10 days, and remaining 5 days are "Year End"?
                    // The previous logic I wrote was:
                    // const daysInXun = (i <= 35) ? XUN_DAYS : 5;
                    // This covers 350 + 5 = 355. Wait.
                    // 365 days.
                    // 36 x 10 = 360. Remaining 5.
                    // Let's adjust logic:
                    // 1-35: 10 days. (350 days)
                    // 36: Remaining days (15 or 16).
                    
                    // Wait, previous code:
                    // const daysInXun = (i <= 35) ? XUN_DAYS : 5;
                    // 35 * 10 = 350. + 5 = 355.
                    // 2026 is 365 days. We are missing 10 days!
                    // Let's re-verify 36 x 10.
                    // If strictly 10 days per xun, we need 36.5 xuns.
                    // Or maybe 12 months * 3 xuns = 36 xuns.
                    // Each month: Early (1-10), Mid (11-20), Late (21-End).
                    // Late is 28/29/30/31 - 20 = 8~11 days.
                    // So "10 days" is approximate for the last xun of month.
                    // Let's switch to standard "Month 3 Xun" logic to be more calendar-accurate?
                    // OR stick to the user's "36 x 10" strict concept.
                    // The user shared an image: "Day 1-10".
                    // Image 1: "01.01-01.10", "01.11-01.20", "01.21-01.30", "01.31-02.09".
                    // Ah! It ignores month boundaries! It's strictly 10-day blocks.
                    // 36 * 10 = 360 days.
                    // 36th xun ends Dec 26.
                    // What about Dec 27-31?
                    // Let's make the 36th xun longer to cover the year, OR add a 37th small period?
                    // User says "36ä¸ª10å¤©".
                    // Let's keep 1-35 as 10 days.
                    // 36th xun: Dec 27 is start? No.
                    // 35 * 10 = 350 days. Ends Dec 16 (approx).
                    // 36th xun starts Dec 17. 10 days -> Dec 26.
                    // Remaining: Dec 27-31 (5 days).
                    // Let's extend the 36th xun to include the rest of the year.
                    
                    let daysInXun = 10;
                    if (i === 36) {
                         // Calculate remaining days in year
                         const yearEnd = new Date(year, 11, 31);
                         const diffTime = Math.abs(yearEnd - currentDate);
                         const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                         daysInXun = diffDays + 1; // +1 to include today
                    }

                    currentDate.setDate(currentDate.getDate() + daysInXun);
                    const endDate = new Date(currentDate);
                    endDate.setDate(endDate.getDate() - 1);
                    periods.push({ index: i, startDate, endDate, days: daysInXun });
                }
                return periods;
            }

            function getCurrentXun(periods) {
                const now = new Date();
                if (now.getFullYear() !== YEAR) return null;
                return periods.find(p => now >= p.startDate && now <= p.endDate) || null;
            }

            function saveUserData() {
                localStorage.setItem('xun_calendar_data_v2', JSON.stringify(userData));
                // Update macro view checkboxes if visible
                if (!macroView.classList.contains('hidden')) {
                     // Optimistic update or full re-render? Full re-render is safest for consistency
                     // But might lose input focus.
                     // Better to just update specific row or rely on user navigating back.
                     // Since modal covers everything, when modal closes, we can refresh.
                }
            }

            function saveMacroGoals() {
                localStorage.setItem('xun_macro_goals', JSON.stringify(macroGoals));
            }
            
            // --- View Management ---
            let hasScrolledToCurrentXun = false;

            window.scrollToCurrentXun = (force = false) => {
                // If already scrolled and not forced, skip
                if (hasScrolledToCurrentXun && !force) return;
                
                // 1. URL Param
                const urlParams = new URLSearchParams(window.location.search);
                let targetXun = parseInt(urlParams.get('xun'));
                
                // 2. Local Cache
                if (!targetXun) {
                    const cached = localStorage.getItem('xun_last_viewed_index');
                    if (cached) targetXun = parseInt(cached);
                }

                // 3. Fallback to Today's Xun
                if (!targetXun && currentXun) {
                    targetXun = currentXun.index;
                }
                
                if (targetXun) {
                    // Mark as scrolled
                    hasScrolledToCurrentXun = true;
                    // Save to cache for next time
                    localStorage.setItem('xun_last_viewed_index', targetXun);
                    
                    setTimeout(() => {
                        const el = document.getElementById(`xun-row-${targetXun}`);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Highlight effect
                            const originalBg = el.style.backgroundColor;
                            el.style.transition = 'background-color 0.5s';
                            el.style.backgroundColor = '#eff6ff'; // blue-50
                            setTimeout(() => {
                                el.style.backgroundColor = originalBg;
                            }, 1000);
                        }
                    }, 300);
                }
            };

            function showView(viewName, data) {
                console.log('Showing view:', viewName, data);
                // Hide main views
                [overviewView, summaryView, macroView].forEach(v => v.classList.add('hidden'));
                
                // Reset Nav State
                const baseNavClass = "px-3 md:px-6 py-2 text-xs md:text-sm font-medium focus:outline-none cursor-pointer transition-colors";
                const inactiveClass = "text-gray-500 hover:text-gray-700 border-b-2 border-transparent";
                const activeClass = "text-blue-600 border-b-2 border-blue-600";

                navMacro.className = `${baseNavClass} ${inactiveClass}`;
                navOverview.className = `${baseNavClass} ${inactiveClass}`;
                navMacro.style.borderBottom = ""; // Clear inline style if any (though we use class now for border, but JS logic used inline style previously)
                navOverview.style.borderBottom = "";

                if (viewName === 'macro') {
                    macroView.classList.remove('hidden');
                    navMacro.className = `${baseNavClass} ${activeClass}`;
                    renderMacroView();
                    window.scrollToCurrentXun();
                } else if (viewName === 'overview') {
                    overviewView.classList.remove('hidden');
                    navOverview.className = `${baseNavClass} ${activeClass}`;
                    renderOverview();
            // Always show detail view
            if (data) {
                renderDetailView(data);
            } else if (currentDetailPeriod) {
                renderDetailView(currentDetailPeriod);
            } else if (currentXun) {
                renderDetailView(currentXun);
            } else if (xunPeriods.length > 0) {
                 renderDetailView(xunPeriods[0]);
            }
        } else if (viewName === 'detail') {
                    // Detail is now part of Overview
                    overviewView.classList.remove('hidden');
                    // Use same active class as overview
                    const baseNavClass = "px-3 md:px-6 py-2 text-xs md:text-sm font-medium focus:outline-none cursor-pointer transition-colors";
                    const activeClass = "text-blue-600 border-b-2 border-blue-600";
                    navOverview.className = `${baseNavClass} ${activeClass}`;
                    navOverview.style.borderBottom = "";
                    
                    // Render Grid (if not already there? It's cheap)
                    renderOverview();
                    
                    // Handle missing data/fallback
                    if (!data) {
                        if (currentDetailPeriod) {
                            data = currentDetailPeriod;
                        } else {
                            // Fallback to current date's Xun
                            const todayStr = formatLocalDate(new Date());
                            const foundXun = xunPeriods.find(p => {
                                const start = formatLocalDate(new Date(p.startDate));
                                const end = formatLocalDate(new Date(p.endDate));
                                return todayStr >= start && todayStr <= end;
                            });
                            data = foundXun || xunPeriods[0];
                        }
                    }

                    currentDetailPeriod = data;
                    renderDetailView(data);
                    
                    // Scroll to detail section
                    detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (viewName === 'summary') {
                    const view = document.getElementById('summary-view');
                    view.classList.remove('hidden');
                    renderSummaryView(data);
                }
                // window.scrollTo(0, 0); // Remove auto scroll top, let user context decide
            }

            // --- Rendering ---
            function renderMacroView() {
                macroList.innerHTML = '';
                const todayStr = formatLocalDate(new Date()); // Added for today highlighting
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const tomorrowStart = new Date(todayStart);
                tomorrowStart.setDate(tomorrowStart.getDate() + 1);
                xunPeriods.forEach((period, index) => {
                    const row = document.createElement('div');
                    row.id = `xun-row-${period.index}`; // Add ID for scrolling
                    row.className = "grid grid-cols-1 md:grid-cols-12 gap-0 text-sm group hover:bg-opacity-80 transition-colors border-b border-gray-100 md:border-none relative";
                    
                    // Gradient Background
                    const hue = (index * 10) % 360;
                    row.style.backgroundColor = `hsl(${hue}, 70%, 96%)`;
                    
                    // Check if current xun
                    if (currentXun && currentXun.index === period.index) {
                         row.classList.add('ring-2', 'ring-blue-400', 'z-10');
                    }

                    // Format Date
                    const startStr = `${String(period.startDate.getMonth()+1).padStart(2, '0')}.${String(period.startDate.getDate()).padStart(2, '0')}`;
                    const endStr = `${String(period.endDate.getMonth()+1).padStart(2, '0')}.${String(period.endDate.getDate()).padStart(2, '0')}`;
                    
                    // Goal & Remarks
                    const goal = macroGoals[period.index]?.goal || '';
                    const remark = macroGoals[period.index]?.remark || '';

                    // Progress (Checkboxes - Now Interactive Goal Check-in)
                    let progressHtml = '<div class="flex items-center justify-center h-full space-x-[2px]">';
                    let tempDate = new Date(period.startDate);
                    while (tempDate <= period.endDate) {
                        const dStr = formatLocalDate(tempDate);
                        const data = userData[dStr] || {};
                        const isChecked = data.goal_checkin === true;
                        const isFuture = tempDate >= tomorrowStart;
                        const isToday = dStr === todayStr;
                        
                        let bgClass = isChecked ? '' : 'bg-white';
                        let borderClass = isChecked ? '' : 'border-gray-300';
                        let opacityClass = isFuture ? 'opacity-40 cursor-not-allowed' : 'opacity-100 cursor-pointer hover:scale-110';
                        let additionalClass = '';
                        
                        const xunColor = `hsl(${hue}, 80%, 60%)`;
                        let style = isChecked 
                            ? `background-color: ${xunColor}; border-color: ${xunColor};` 
                            : `border-color: #d1d5db;`;
                        
                        if (isToday) {
                             borderClass = 'border-2 border-blue-500 z-10';
                             additionalClass = 'ring-2 ring-blue-200 shadow-md animate-pulse';
                             // Ensure inline style doesn't override border color for today
                             style = isChecked 
                                ? `background-color: ${xunColor}; border-color: #3b82f6;` 
                                : `border-color: #3b82f6;`;
                        }
                        
                        const tip = isFuture 
                            ? `${dStr} (å°šæœªåˆ°æ¥)` 
                            : (isChecked ? `${dStr}: å·²æ‰“å¡ - ${goal || 'å®Œæˆç›®æ ‡'}` : `${dStr}: ç‚¹å‡»æ‰“å¡ - ${goal || 'è®°å½•ä»Šæ—¥æˆæœ'}`);

                        const clickHandler = isFuture ? '' : `onclick="window.toggleGoalCheckin('${dStr}', ${index})"`;

                        // Mobile: larger touch targets (w-4 h-4), Desktop: compact (w-2.5 h-2.5)
                        progressHtml += `<div class="w-5 h-5 md:w-2.5 md:h-2.5 rounded-[1px] border ${bgClass} ${borderClass} ${opacityClass} ${additionalClass} transition-all duration-200 flex-shrink-0" 
                            style="${style}" 
                            title="${tip}"
                            ${clickHandler}></div>`;
                            
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                    progressHtml += '</div>';

                    row.innerHTML = `
                        <!-- Index & Date (Mobile: Header, Desktop: Col 1 & 2) -->
                        <div class="col-span-1 md:col-span-1 flex items-center justify-between md:justify-center p-3 md:py-3 md:px-0 bg-gray-50/50 md:bg-transparent border-b md:border-b-0 md:border-r border-black/5 cursor-pointer hover:bg-black/5" onclick="window.showXunDetail(${index})">
                            <span class="font-mono text-gray-900 font-extrabold md:font-bold">ç¬¬ ${period.index} æ—¬</span>
                            <span class="md:hidden text-xs text-gray-400 font-mono">${startStr} - ${endStr}</span>
                        </div>
                        
                        <div class="hidden md:flex col-span-2 items-center justify-center font-mono text-gray-600 border-r border-black/5 text-xs">
                            ${startStr} - ${endStr}
                        </div>

                        <!-- Goal Input -->
                        <div class="col-span-1 md:col-span-4 border-b md:border-b-0 md:border-r border-black/5 p-3 md:p-1 flex flex-col justify-center">
                            <label class="md:hidden text-xs text-gray-400 font-bold mb-1">æ ¸å¿ƒç›®æ ‡</label>
                            <textarea class="w-full bg-transparent border-none focus:ring-0 text-gray-700 placeholder-gray-400/70 text-sm resize-none overflow-hidden" 
                                placeholder="æœ¬æ—¬æ ¸å¿ƒç›®æ ‡..." rows="1" 
                                oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'"
                                onchange="window.updateMacroGoal(${period.index}, 'goal', this.value)">${goal}</textarea>
                        </div>

                        <!-- Check-in Dots -->
                        <div class="col-span-1 md:col-span-3 border-b md:border-b-0 md:border-r border-black/5 py-3 md:py-1 flex flex-col md:flex-row items-center justify-center overflow-x-auto">
                            <label class="md:hidden text-xs text-gray-400 font-bold mb-2">æ¯æ—¥æ‰“å¡</label>
                            ${progressHtml}
                        </div>

                        <!-- Remark -->
                        <div class="col-span-1 md:col-span-2 p-3 md:p-1 flex flex-col justify-center">
                            <label class="md:hidden text-xs text-gray-400 font-bold mb-1">å¤‡æ³¨</label>
                            <textarea class="w-full bg-transparent border-none focus:ring-0 text-gray-500 text-xs md:text-center resize-none overflow-hidden" 
                                placeholder="å¤‡æ³¨" rows="1" 
                                oninput="this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'"
                                onchange="window.updateMacroGoal(${period.index}, 'remark', this.value)">${remark}</textarea>
                        </div>
                    `;
                    
                    macroList.appendChild(row);
                });
                
                // Expose helper to global scope for onclick
                window.showXunDetail = (index) => {
                    showView('detail', xunPeriods[index]); 
                };

                window.showView = showView; // Expose showView for inline onclick handlers

                window.scrollToGrid = () => {
                    const grid = document.getElementById('overview-grid');
                    if (grid) {
                        grid.scrollIntoView({ behavior: 'smooth' });
                    }
                };

                window.goToMacro = () => {
                    showView('macro');
                };


                window.updateMacroGoal = (xunIndex, field, value) => {
                    if (!macroGoals[xunIndex]) macroGoals[xunIndex] = {};
                    macroGoals[xunIndex][field] = value;
                    saveMacroGoals();
                    renderMacroView(); // Re-render to update tooltips
                };

                window.toggleGoalCheckin = (dateStr, xunIndex) => {
                    if (!userData[dateStr]) userData[dateStr] = {};
                    // Toggle
                    userData[dateStr].goal_checkin = !userData[dateStr].goal_checkin;
                    saveUserData();
                    renderMacroView();
                    // Also update overview if visible? No, this is Macro view.
                };

                // --- Navigation Helpers ---
                window.changeXunDetail = (offset) => {
                    if (!currentDetailPeriod) return;
                    const newIndex = currentDetailPeriod.index + offset;
                    if (newIndex < 1 || newIndex > 36) return; // Boundary check
                    showView('detail', xunPeriods[newIndex - 1]);
                };


            }

            function renderOverview() {
                overviewGrid.innerHTML = '';
                overviewGrid.className = 'flex flex-wrap gap-1 justify-center p-2 md:p-4 bg-white rounded-xl shadow-sm border border-gray-100'; 
                
                const legend = document.createElement('div');
                legend.className = "w-full flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b border-gray-50 gap-2";
                legend.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-gray-500">æ¯æ—¥è®°å½•ï¼ˆè®°å½•çƒ­åº¦ï¼‰</span>
                        <span class="text-[11px] text-gray-500">ç‚¹å‡»ä»»æ„æ—¥æœŸï¼Œè‡ªåŠ¨æ‰“å¼€ä¸‹æ–¹æ—¬æ—¥å†</span>
                    </div>
                    <div class="flex flex-wrap gap-4 text-xs text-gray-500">
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-[1px] bg-gray-50 border border-gray-200"></span> 
                            <span>æœªè®°å½•</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-[1px] shadow-sm" style="background-color: hsl(210, 85%, 60%)"></span> 
                            <span>å·²è®°å½•</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-[1px] border-2 border-blue-400 bg-white"></span> 
                            <span>ä»Šå¤©</span>
                        </div>
                    </div>
                `;
                overviewGrid.appendChild(legend);

                const start = new Date(YEAR, 0, 1);
                const end = new Date(YEAR, 11, 31);
                
                const dateToXunMap = {};
                xunPeriods.forEach(p => {
                    let d = new Date(p.startDate);
                    while (d <= p.endDate) {
                        dateToXunMap[formatLocalDate(d)] = p;
                        d.setDate(d.getDate() + 1);
                    }
                });

                const todayStr = formatLocalDate(new Date());
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatLocalDate(d);
                    const xun = dateToXunMap[dateStr];
                    const xunIndex = xun ? xun.index : 0;
                    
                    const el = document.createElement('div');
                    el.className = 'w-3 h-3 md:w-4 md:h-4 rounded-[1px] cursor-pointer transition-all duration-200 hover:scale-125 relative group';
                    
                    // Enhanced Color Saturation/Lightness for "Obvious Gradient"
                    // Original: hsl(hue, 70%, 96%) / hsl(hue, 70%, 60%)
                    // New: hsl(hue, 85%, 85%) / hsl(hue, 85%, 55%)
                    const hue = (xunIndex * 10) % 360;
                    
                    const data = userData[dateStr];
                    const hasIndicators = data && Array.isArray(data.indicator_checkins) && data.indicator_checkins.some(v => v === true);
                    const hasGoalActions = data && Array.isArray(data.goal_actions) && data.goal_actions.length > 0;
                    const hasKeywords = data && Array.isArray(data.keywords) && data.keywords.length > 0;
                    const hasData = data && (data.mood || data.journal || data.weather || data.goal_checkin || data.goal_confidence || data.goal_blockers || hasGoalActions || hasIndicators || hasKeywords);
                    
                    if (hasData) {
                         el.style.backgroundColor = `hsl(${hue}, 85%, 60%)`; // Stronger saturation
                         el.style.boxShadow = `0 0 2px hsl(${hue}, 85%, 40%)`;
                    } else {
                         el.style.backgroundColor = `hsl(${hue}, 85%, 90%)`; // Slightly more visible base
                    }

                    if (dateStr === todayStr) {
                         el.style.border = '2px solid #3b82f6'; // blue-500
                         el.classList.add('z-10');
                    }
                    
                    // Mood Emoji Map
                    const moodEmojis = {1: 'ğŸ˜«', 2: 'ğŸ˜', 3: 'ğŸ˜', 4: 'ğŸ™‚', 5: 'ğŸ¤©'};
                    const moodEmoji = data && data.mood ? moodEmojis[data.mood] : (data && data.emoji ? data.emoji : '');
                    
                    // Tooltip
                    const keywordsStr = data && data.keywords ? ` [${data.keywords.join(' ')}]` : '';
                    const goalStr = data && data.goal_checkin ? ' ğŸ¯' : '';
                    const xunIndicators = Array.isArray(macroGoals[xunIndex]?.indicators) ? macroGoals[xunIndex].indicators : [];
                    const indicatorTotal = xunIndicators.length;
                    const indicatorDone = data && Array.isArray(data.indicator_checkins)
                        ? data.indicator_checkins.slice(0, indicatorTotal).filter(v => v === true).length
                        : 0;
                    const indicatorStr = indicatorTotal > 0 ? ` ğŸ“Œ${indicatorDone}/${indicatorTotal}` : '';
                    el.title = `${dateStr} ${moodEmoji}${goalStr}${indicatorStr}${keywordsStr} (ç¬¬ ${xunIndex} æ—¬)`;
                    
                    // Click to go to detail (which is now below)
                    if (xun) {
                        el.onclick = () => {
                             currentDetailPeriod = xun;
                             renderDetailView(xun);
                             // Optional: Scroll to detail?
                             // detailSection.scrollIntoView({ behavior: 'smooth' });
                        };
                    }

                    overviewGrid.appendChild(el);
                }
            }

            function renderDetailView(period) {
                try {
                    const detailTitle = document.getElementById('detail-title');
                    const container = document.getElementById('detail-calendars-container');
                    const detailContent = document.getElementById('detail-content');
                    
                    detailContent.classList.remove('hidden');

                    container.innerHTML = '';
                    currentDetailPeriod = period; // Sync state

                    const startMonth = period.startDate.getMonth();
                    const endMonth = period.endDate.getMonth();
                    
                    const startMonthDisplay = startMonth + 1;
                    const endMonthDisplay = endMonth + 1;
                    const monthDisplay = startMonth === endMonth ? `${startMonthDisplay}æœˆ` : `${startMonthDisplay}æœˆ - ${endMonthDisplay}æœˆ`;
                    
                    // Enhanced Header with Xun Color
                    const hue = (period.index * 10) % 360;
                    const xunColor = `hsl(${hue}, 85%, 60%)`;
                    // Stronger gradient for background
                    const xunBg = `linear-gradient(to bottom, hsl(${hue}, 85%, 98%), #f9fafb)`;
                    
                    // Apply gradient to the section
                    detailContent.style.background = xunBg;

                    detailTitle.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <button onclick="window.changeXunDetail(-1)" class="p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-full hover:bg-white/50" title="ä¸Šä¸€æ—¬">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div class="flex items-center gap-3">
                                <span class="px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm" style="background-color: ${xunColor}">
                                    ç¬¬ ${period.index} æ—¬
                                </span>
                                <span class="text-xl font-light text-gray-800">2026å¹´ ${monthDisplay}</span>
                            </div>
                            <button onclick="window.changeXunDetail(1)" class="p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-full hover:bg-white/50" title="ä¸‹ä¸€æ—¬">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    // Update Summary Button
                    const summaryBtn = document.getElementById('show-summary-btn');
                    if(summaryBtn) {
                         summaryBtn.onclick = () => showView('summary', period);
                         summaryBtn.style.backgroundColor = xunColor;
                         summaryBtn.className = "px-3 py-1 text-sm text-white rounded-md hover:opacity-90 shadow-sm transition-colors";
                    }

                    // ç¡®å®šéœ€è¦æ¸²æŸ“çš„æœˆä»½åˆ—è¡¨
                    const monthsToRender = [];
                    monthsToRender.push(new Date(period.startDate.getFullYear(), startMonth, 1));
                    if (startMonth !== endMonth) {
                        monthsToRender.push(new Date(period.startDate.getFullYear(), endMonth, 1));
                    }

                    monthsToRender.forEach(monthStart => {
                        const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
                        
                        // æœˆä»½å®¹å™¨
                        const monthWrapper = document.createElement('div');
                        monthWrapper.className = 'bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm border border-gray-100/50 overflow-hidden mb-6';
                        
                        // æœˆä»½æ ‡é¢˜
                        const monthHeader = document.createElement('div');
                        monthHeader.className = 'bg-white/50 px-4 py-3 md:px-6 md:py-4 border-b border-gray-50 font-light text-xl text-gray-800 flex justify-between items-center';
                        monthHeader.innerHTML = `<span>${monthStart.getMonth() + 1}æœˆ</span><span class="text-xs text-gray-300 font-mono">${monthStart.getFullYear()}</span>`;
                        monthWrapper.appendChild(monthHeader);

                        // æ˜ŸæœŸè¡¨å¤´
                        const gridHeader = document.createElement('div');
                        gridHeader.className = 'grid grid-cols-7 bg-gray-50/30 border-b border-gray-100';
                        gridHeader.innerHTML = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(d => `<div class="text-center font-medium text-[8px] md:text-[10px] text-gray-400 py-2 md:py-3 tracking-wider">${d}</div>`).join('');
                        monthWrapper.appendChild(gridHeader);

                        // æ—¥æœŸç½‘æ ¼
                        const gridBody = document.createElement('div');
                        gridBody.className = 'grid grid-cols-7 bg-white/60';
                        
                        // è¡¥é½æœˆåˆç©ºç™½
                        for (let i = 0; i < monthStart.getDay(); i++) {
                            const empty = document.createElement('div');
                            empty.className = "border-t border-r border-gray-50 bg-gray-50/10 h-20 md:h-28";
                            gridBody.appendChild(empty);
                        }

                        let currentDate = new Date(monthStart);
                        while (currentDate <= monthEnd) {
                            const dateStr = formatLocalDate(currentDate);
                            const dayData = userData[dateStr] || {};
                            const isWithinXun = currentDate >= period.startDate && currentDate <= period.endDate;
                            
                            let jieQi = '', lunarDay = '';
                            let holidayName = '';
                            let isHoliday = false;
                            
                            const dayEl = document.createElement('div');

                            if (typeof Solar !== 'undefined') {
                                const solar = Solar.fromYmd(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
                                const lunar = solar.getLunar();
                                jieQi = lunar.getJieQi();
                                lunarDay = lunar.getDayInChinese() === 'åˆä¸€' ? lunar.getMonthInChinese() + 'æœˆ' : lunar.getDayInChinese();
                                
                                if (typeof HolidayUtil !== 'undefined') {
                                    const h = HolidayUtil.getHoliday(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
                                    if (h) {
                                        holidayName = h.getName();
                                        isHoliday = !h.isWork();
                                    }
                                }
                            }

                            // Style update: Dynamic height and width logic
                            const baseClass = `p-1 md:p-3 border-t border-r border-gray-50 min-h-[5rem] md:min-h-[7rem] max-h-[20rem] overflow-y-auto h-auto flex flex-col relative transition-all duration-200 group`;
                            const activeClass = `cursor-pointer`; // We set BG manually
                            const inactiveClass = `bg-gray-50/40 text-gray-300 grayscale opacity-50`;

                            dayEl.className = `${baseClass} ${isWithinXun ? activeClass : inactiveClass}`;
                            
                            // Xun color gradient
                            if (isWithinXun) {
                                // Stronger gradient
                                dayEl.style.background = `linear-gradient(135deg, hsl(${hue}, 90%, 96%) 0%, hsl(${hue}, 80%, 92%) 100%)`;
                                dayEl.style.boxShadow = `inset 0 0 0 1px hsl(${hue}, 80%, 80%)`;
                            } else {
                                dayEl.style.background = 'white';
                            }

                            if (dayData.mood) {
                                dayEl.classList.add(`mood-${dayData.mood}`); 
                            }
                            
                            // Date Number
                            const dateColor = isWithinXun ? (dayData.mood ? 'text-gray-800' : 'text-gray-700') : 'text-gray-300';
                            const subText = holidayName 
                                ? `<span class="${isHoliday ? 'text-red-500 font-bold' : 'text-gray-500'}">${holidayName}</span>` 
                                : (jieQi ? `<span class="text-blue-500 font-medium">${jieQi}</span>` : lunarDay);

                            // Mood Emoji Map
                            const moodEmojis = {1: 'ğŸ˜«', 2: 'ğŸ˜', 3: 'ğŸ˜', 4: 'ğŸ™‚', 5: 'ğŸ¤©'};
                            const displayEmoji = dayData.mood ? moodEmojis[dayData.mood] : (dayData.emoji || '');

                            let indicators = [];
                            if (dayData.goal_checkin) indicators.push('<span title="æ ¸å¿ƒç›®æ ‡">ğŸ¯</span>');
                            if (isWithinXun) {
                                const xunIndicators = Array.isArray(macroGoals[period.index]?.indicators) ? macroGoals[period.index].indicators : [];
                                const checkins = Array.isArray(dayData.indicator_checkins) ? dayData.indicator_checkins : [];
                                const marks = ['â‘ ', 'â‘¡', 'â‘¢'];
                                for (let i = 0; i < 3; i++) {
                                    if (checkins[i] === true) {
                                        const title = xunIndicators[i] ? `æŒ‡æ ‡ï¼š${xunIndicators[i]}` : `æŒ‡æ ‡${i + 1}`;
                                        indicators.push(`<span title="${title}">${marks[i]}</span>`);
                                    }
                                }
                            }
                            if (dayData.goal_actions && dayData.goal_actions.length > 0) indicators.push('<span title="æœ€å°è¡ŒåŠ¨">âœ…</span>');
                            if (dayData.goal_blockers) indicators.push('<span title="é˜»ç¢">ğŸš§</span>');
                            if (dayData.metrics) {
                                if (dayData.metrics.exercise > 0) indicators.push('<span title="è¿åŠ¨">ğŸƒ</span>');
                                if (dayData.metrics.reading > 0) indicators.push('<span title="é˜…è¯»">ğŸ“š</span>');
                            }
                            if (dayData.journal || (dayData.emotions && dayData.emotions.length > 0)) {
                                indicators.push('<span title="æ—¥è®°/æƒ…ç»ª">ğŸ“</span>');
                            }
                            
                            // Weather Icon Helper
                            const getWeatherIcon = (w) => {
                                const map = { 'Sunny': 'â˜€ï¸', 'Cloudy': 'â˜ï¸', 'Overcast': 'ğŸŒ¥ï¸', 'Rainy': 'ğŸŒ§ï¸', 'Snowy': 'â„ï¸', 'Windy': 'ğŸŒ¬ï¸', 'Foggy': 'ğŸŒ«ï¸', 'Thunder': 'âš¡' };
                                return map[w] || '';
                            };

                            dayEl.innerHTML = `
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs md:text-sm font-medium ${dateColor} group-hover:text-blue-600 transition-colors">${currentDate.getDate()}</span>
                                    <span class="text-[8px] md:text-[10px] ${holidayName ? '' : 'text-gray-400'} scale-90 origin-right transform">${subText}</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center justify-center w-full">
                                     ${displayEmoji ? `<div class="text-xl md:text-2xl filter drop-shadow-sm transform group-hover:scale-110 transition-transform mb-1">${displayEmoji}</div>` : ''}
                                     
                                     ${dayData.keywords && dayData.keywords.length > 0 ? `
                                        <div class="flex flex-wrap justify-center gap-0.5 mb-1 w-full px-0.5">
                                            ${dayData.keywords.slice(0, 3).map(k => `<span class="text-[8px] leading-tight text-gray-500 bg-white/50 px-1 rounded-sm border border-gray-100/50 break-words whitespace-normal max-w-full text-center">${k}</span>`).join('')}
                                        </div>
                                     ` : ''}

                                     <div class="flex gap-0.5 md:gap-1 text-[8px] md:text-[10px] opacity-70 flex-wrap justify-center mt-auto">
                                        ${indicators.join('')}
                                        ${dayData.weather ? `<span title="${dayData.weather}">${getWeatherIcon(dayData.weather)}</span>` : ''}
                                     </div>
                                </div>
                            `;

                            if (isWithinXun) {
                                const dStr = dateStr;
                                dayEl.addEventListener('click', () => openModal(dStr));
                            }
                            
                            gridBody.appendChild(dayEl);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }

                        monthWrapper.appendChild(gridBody);
                        container.appendChild(monthWrapper);
                    });
                } catch (e) {
                    console.error('Error rendering detail view:', e);
                }
            }

            function renderSummaryView(period) {
                const summaryTitle = document.getElementById('summary-title');
                const summaryContent = document.getElementById('summary-content');
                
                // Title Styling
                const startStr = `${period.startDate.getMonth()+1}.${period.startDate.getDate()}`;
                const endStr = `${period.endDate.getMonth()+1}.${period.endDate.getDate()}`;
                const hue = (period.index * 10) % 360;
                
                summaryTitle.innerHTML = `
                    <div class="flex flex-col items-center mb-8">
                        <div class="px-4 py-1 rounded-full text-xs font-medium bg-white border shadow-sm mb-3" style="color: hsl(${hue}, 70%, 40%); border-color: hsl(${hue}, 70%, 80%)">
                            ${startStr} - ${endStr}
                        </div>
                        <h2 class="text-3xl font-light text-gray-800">ç¬¬ ${period.index} æ—¬å›é¡¾</h2>
                    </div>
                `;
                
                summaryContent.innerHTML = '';
                summaryContent.className = "max-w-4xl mx-auto space-y-8"; // Reset and add layout classes

                const xunData = [];
                let currentDate = new Date(period.startDate);
                while (currentDate <= period.endDate) {
                    const dateStr = formatLocalDate(currentDate);
                    // Always push a record for every day in the Xun, even if empty
                    if (userData[dateStr]) {
                        xunData.push({ date: dateStr, ...userData[dateStr], hasData: true });
                    } else {
                        xunData.push({ date: dateStr, hasData: false });
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (xunData.every(d => !d.hasData)) {
                    summaryContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-gray-100 shadow-sm text-center">
                            <div class="text-6xl mb-4 opacity-20">ğŸ“</div>
                            <p class="text-gray-500 font-light text-lg">æœ¬æ—¬æš‚æ— è®°å½•ï¼Œä¼‘æ¯ä¸€ä¸‹å§ã€‚</p>
                            <button onclick="window.showView('detail')" class="mt-6 px-6 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors shadow-md">å»è®°å½•</button>
                        </div>
                    `;
                    return;
                }

                const stats = {
                    moodCounts: [0, 0, 0, 0, 0],
                    emotionCounts: {},
                    sleep: { total: 0, count: 0 },
                    exercise: { total: 0, count: 0 },
                    reading: { total: 0, count: 0 },
                    wealth: 0,
                    customActivities: {},
                    journals: [],
                    dates: xunData.map(d => d.date.slice(5)), // Now contains all dates
                    sleepData: [],
                    exerciseData: [],
                    readingData: [],
                };

                xunData.forEach(data => {
                    if (data.hasData) {
                        if (data.mood) stats.moodCounts[data.mood - 1]++;
                        if (data.emotions) {
                            data.emotions.forEach(tag => {
                                stats.emotionCounts[tag] = (stats.emotionCounts[tag] || 0) + 1;
                            });
                        }
                        if (data.metrics) {
                            if (data.metrics.sleep) { stats.sleep.total += data.metrics.sleep; stats.sleep.count++; }
                            if (data.metrics.exercise) { stats.exercise.total += data.metrics.exercise; stats.exercise.count++; }
                            if (data.metrics.reading) { stats.reading.total += data.metrics.reading; stats.reading.count++; }
                            if (data.metrics.wealth) stats.wealth += data.metrics.wealth;
                        }
                        if (data.custom_activities) {
                            data.custom_activities.forEach(act => {
                                stats.customActivities[act.name] = (stats.customActivities[act.name] || 0) + 1;
                            });
                        }
                        if (data.journal) stats.journals.push({ date: data.date, content: data.journal });
                        
                        stats.sleepData.push(data.metrics?.sleep || null);
                        stats.exerciseData.push(data.metrics?.exercise || null);
                        stats.readingData.push(data.metrics?.reading || null);
                    } else {
                        // For days with no data, push null to charts to maintain x-axis alignment
                        stats.sleepData.push(null);
                        stats.exerciseData.push(null);
                        stats.readingData.push(null);
                    }
                });

                // Layout Structure
                summaryContent.innerHTML = `
                    <!-- 1. Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
                            <span class="text-2xl mb-2">ğŸ˜´</span>
                            <span class="text-sm text-gray-400 mb-1">å¹³å‡ç¡çœ </span>
                            <span class="text-xl font-semibold text-gray-700">${(stats.sleep.count > 0 ? (stats.sleep.total / stats.sleep.count).toFixed(1) : '-')} <span class="text-xs font-normal text-gray-400">h</span></span>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
                            <span class="text-2xl mb-2">ğŸƒ</span>
                            <span class="text-sm text-gray-400 mb-1">æ€»è¿åŠ¨</span>
                            <span class="text-xl font-semibold text-gray-700">${stats.exercise.total} <span class="text-xs font-normal text-gray-400">min</span></span>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
                            <span class="text-2xl mb-2">ğŸ“š</span>
                            <span class="text-sm text-gray-400 mb-1">æ€»é˜…è¯»</span>
                            <span class="text-xl font-semibold text-gray-700">${stats.reading.total} <span class="text-xs font-normal text-gray-400">min</span></span>
                        </div>
                         <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center">
                            <span class="text-2xl mb-2">ğŸ’°</span>
                            <span class="text-sm text-gray-400 mb-1">è´¢å¯Œå˜åŠ¨</span>
                            <span class="text-xl font-semibold ${stats.wealth >= 0 ? 'text-green-500' : 'text-red-500'}">${stats.wealth > 0 ? '+' : ''}${stats.wealth.toFixed(0)}</span>
                        </div>
                    </div>

                    <!-- 1.5 Emotion Keywords -->
                    ${Object.keys(stats.emotionCounts).length > 0 ? `
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <h4 class="font-medium text-gray-700 mb-4 flex items-center gap-2">
                                <span class="w-1 h-4 rounded-full bg-pink-400"></span> æƒ…ç»ªå…³é”®è¯
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                ${Object.entries(stats.emotionCounts).sort((a,b) => b[1] - a[1]).map(([tag, count]) => `
                                    <span class="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-sm border border-gray-100 flex items-center gap-2">
                                        ${tag} <span class="text-xs bg-gray-200 text-gray-500 rounded-full px-1.5 py-0.5">${count}</span>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- 2. Charts Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Mood Chart -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col relative z-0 overflow-visible">
                            <h4 class="font-medium text-gray-700 mb-4 flex items-center gap-2 relative z-10">
                                <span class="w-1 h-4 rounded-full bg-blue-400"></span> å¿ƒæƒ…åˆ†å¸ƒ
                                <div class="ml-auto group relative">
                                    <span class="text-xs font-normal text-gray-400 cursor-help border-b border-dashed border-gray-300">æ¥è‡ªâ€œä»Šæ—¥æ•´ä½“æ„Ÿå—â€</span>
                                    <!-- Tooltip -->
                                    <div class="hidden group-hover:block absolute right-0 top-full mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-xl shadow-xl z-50 text-left leading-relaxed">
                                        <p class="mb-2">â€¢ å®ƒä¼šè¯»å–æ‚¨åœ¨è¿™10å¤©ï¼ˆä¸€æ—¬ï¼‰å†…æ¯ä¸€æ¬¡æ‰“å¡è®°å½•çš„â€œä»Šæ—¥æ•´ä½“æ„Ÿå—â€ã€‚</p>
                                        <p>â€¢ å®ƒç»Ÿè®¡çš„æ˜¯è¿™5ç§å¿ƒæƒ…å‡ºç°çš„é¢‘ç‡ã€‚ï¼ˆä¾‹å¦‚ï¼šè¿™10å¤©é‡Œæœ‰3å¤©â€œä¸é”™â€ã€2å¤©â€œå¹³æ·¡â€ï¼Œå›¾è¡¨ä¸Šå°±ä¼šç›´è§‚åœ°æ˜¾ç¤ºå‡ºè¿™ç§æ¯”ä¾‹ï¼‰ã€‚</p>
                                        <!-- Arrow -->
                                        <div class="absolute -top-1 right-8 w-2 h-2 bg-gray-800 transform rotate-45"></div>
                                    </div>
                                </div>
                            </h4>
                            <div class="flex-1 min-h-[200px] relative z-0">
                                <canvas id="mood-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Trends Chart -->
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                            <h4 class="font-medium text-gray-700 mb-4 flex items-center gap-2">
                                <span class="w-1 h-4 rounded-full bg-green-400"></span> è¶‹åŠ¿è¿½è¸ª
                            </h4>
                            <div class="flex-1 min-h-[200px] relative">
                                <canvas id="metrics-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Journals & Highlights -->
                    ${stats.journals.length > 0 ? `
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                             <h4 class="font-medium text-gray-700 mb-6 flex items-center gap-2">
                                <span class="w-1 h-4 rounded-full bg-purple-400"></span> é—ªå¿µä¸å¤ç›˜
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                ${stats.journals.map(j => `
                                    <div class="flex gap-4 p-4 rounded-xl bg-gray-50 border border-gray-100 hover:shadow-sm transition-shadow">
                                        <div class="flex-shrink-0 flex flex-col items-center w-12 pt-1">
                                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${new Date(j.date).toLocaleString('en-US', {month:'short'})}</span>
                                            <span class="text-xl font-light text-gray-800">${new Date(j.date).getDate()}</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-gray-600 leading-relaxed text-sm">${j.content}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Render Charts
                setTimeout(() => {
                    const moodChartEl = document.getElementById('mood-chart');
                    const metricsChartEl = document.getElementById('metrics-chart');
                    
                    if (typeof Chart !== 'undefined') {
                        if (moodChartEl) {
                            new Chart(moodChartEl, {
                                type: 'doughnut',
                                data: {
                                    labels: ['1åˆ†', '2åˆ†', '3åˆ†', '4åˆ†', '5åˆ†'],
                                    datasets: [{
                                        data: stats.moodCounts,
                                        backgroundColor: ['#F3F4F6', '#E5E7EB', '#D1D5DB', '#9CA3AF', '#6B7280'], // Grey scale for minimalist
                                        hoverBackgroundColor: [`hsl(${hue}, 70%, 90%)`, `hsl(${hue}, 70%, 80%)`, `hsl(${hue}, 70%, 70%)`, `hsl(${hue}, 70%, 60%)`, `hsl(${hue}, 70%, 50%)`],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    cutout: '70%',
                                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } } }
                                }
                            });
                        }

                        if (metricsChartEl) {
                            new Chart(metricsChartEl, {
                                type: 'line',
                                data: {
                                    labels: stats.dates,
                                    datasets: [
                                        { label: 'ç¡çœ ', data: stats.sleepData, borderColor: '#60A5FA', tension: 0.4, pointRadius: 2 },
                                        { label: 'è¿åŠ¨', data: stats.exerciseData, borderColor: '#34D399', tension: 0.4, pointRadius: 2 },
                                        { label: 'é˜…è¯»', data: stats.readingData, borderColor: '#FBBF24', tension: 0.4, pointRadius: 2 }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: { y: { display: false }, x: { grid: { display: false } } },
                                    plugins: { legend: { position: 'top', align: 'end', labels: { boxWidth: 8, usePointStyle: true } } }
                                }
                            });
                        }
                    }
                }, 100);
            }

            // --- Modal Helpers ---
            function getXunPeriodByDateStr(dateStr) {
                const d = new Date(`${dateStr}T00:00:00`);
                return xunPeriods.find(p => d >= p.startDate && d <= p.endDate) || null;
            }

            function saveCustomEmotions() {
                localStorage.setItem('xun_custom_emotions', JSON.stringify(customEmotions));
            }

            function renderEmotionTags() {
                const container = document.getElementById('emotion-tags');
                if (!container) return;

                const allEmotions = [...defaultEmotions, ...customEmotions.map(t => ({ text: t, value: t }))];
                
                let html = allEmotions.map(emotion => `
                    <button type="button" class="emotion-tag px-3 py-1.5 text-sm border border-gray-200 rounded-full text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-all focus:outline-none focus:ring-2 focus:ring-blue-200" data-tag="${emotion.value}" aria-pressed="false">
                        ${emotion.text}
                    </button>
                `).join('');

                // Add "Add Custom" button
                html += `
                    <button type="button" id="add-custom-emotion-btn" class="px-3 py-1.5 text-sm border border-dashed border-gray-300 rounded-full text-gray-500 hover:bg-gray-50 hover:text-blue-500 hover:border-blue-300 transition-all focus:outline-none focus:ring-2 focus:ring-blue-200" title="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾">
                        + è‡ªå®šä¹‰
                    </button>
                `;

                container.innerHTML = html;
            }

            function addCustomEmotion() {
                const btn = document.getElementById('add-custom-emotion-btn');
                if (!btn) return;

                const container = document.createElement('div');
                container.className = 'inline-flex items-center gap-1 ml-1 align-middle';
                container.innerHTML = `
                    <input type="text" id="custom-emotion-input" class="w-24 px-2 py-1 text-xs border border-blue-300 rounded-full focus:outline-none focus:ring-1 focus:ring-blue-400 placeholder-gray-400" placeholder="æ–°æ ‡ç­¾" autocomplete="off">
                    <button type="button" id="save-custom-emotion" class="p-1 text-green-600 hover:text-green-700 rounded-full hover:bg-green-50" title="ç¡®è®¤">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    <button type="button" id="cancel-custom-emotion" class="p-1 text-gray-400 hover:text-gray-500 rounded-full hover:bg-gray-50" title="å–æ¶ˆ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                `;

                btn.replaceWith(container);

                const input = container.querySelector('input');
                input.focus();

                const handleConfirm = () => confirmAddCustomEmotion(input.value);
                const handleCancel = () => renderEmotionTags();

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };

                container.querySelector('#save-custom-emotion').onclick = (e) => {
                    e.stopPropagation();
                    handleConfirm();
                };

                container.querySelector('#cancel-custom-emotion').onclick = (e) => {
                    e.stopPropagation();
                    handleCancel();
                };
            }

            function confirmAddCustomEmotion(tag) {
                if (tag && tag.trim()) {
                    const cleanTag = tag.trim();
                    if (defaultEmotions.some(e => e.value === cleanTag) || customEmotions.includes(cleanTag)) {
                        alert('è¯¥æ ‡ç­¾å·²å­˜åœ¨ï¼');
                        return;
                    }

                    // Capture current selection before re-rendering
                    const selectedTags = Array.from(document.querySelectorAll('.emotion-tag[aria-pressed="true"]')).map(el => el.dataset.tag);

                    customEmotions.push(cleanTag);
                    saveCustomEmotions();
                    renderEmotionTags();

                    // Restore selection + Select new
                    selectedTags.push(cleanTag);

                    selectedTags.forEach(t => {
                        const el = document.querySelector(`.emotion-tag[data-tag="${t}"]`);
                        if (el) {
                             el.classList.remove('text-gray-600', 'border-gray-200');
                             el.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300', 'ring-1', 'ring-blue-300');
                             el.setAttribute('aria-pressed', 'true');
                        }
                    });
                } else {
                    renderEmotionTags(); // Empty input, just cancel
                }
            }

            // --- Nourishment Helpers ---
            function saveCustomNourishments() {
                localStorage.setItem('xun_custom_nourishments', JSON.stringify(customNourishments));
            }

            function renderNourishmentTags() {
                const container = document.getElementById('nourishment-tags-container');
                if (!container) return;

                const allNourishments = [...defaultNourishments, ...customNourishments.map(t => ({ text: t, value: t }))];
                
                let html = allNourishments.map(item => `
                    <button type="button" class="nourishment-tag px-3 py-1 text-xs rounded-full border border-gray-200 bg-gray-50 text-gray-600 hover:bg-gray-100 transition-colors" data-tag="${item.value}" aria-pressed="false">
                        ${item.text}
                    </button>
                `).join('');

                // Add "Add Custom" button
                html += `
                    <button type="button" id="add-custom-nourishment-btn" class="px-3 py-1 text-xs border border-dashed border-gray-300 rounded-full text-gray-500 hover:bg-gray-50 hover:text-blue-500 hover:border-blue-300 transition-all focus:outline-none focus:ring-2 focus:ring-blue-200" title="æ·»åŠ è‡ªå®šä¹‰æ´»åŠ¨">
                        + è‡ªå®šä¹‰
                    </button>
                `;

                container.innerHTML = html;
            }

            function addCustomNourishment() {
                const btn = document.getElementById('add-custom-nourishment-btn');
                if (!btn) return;

                const container = document.createElement('div');
                container.className = 'inline-flex items-center gap-1 ml-1 align-middle';
                container.innerHTML = `
                    <input type="text" id="custom-nourishment-input" class="w-24 px-2 py-1 text-xs border border-blue-300 rounded-full focus:outline-none focus:ring-1 focus:ring-blue-400 placeholder-gray-400" placeholder="æ–°æ´»åŠ¨" autocomplete="off">
                    <button type="button" id="save-custom-nourishment" class="p-1 text-green-600 hover:text-green-700 rounded-full hover:bg-green-50" title="ç¡®è®¤">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    <button type="button" id="cancel-custom-nourishment" class="p-1 text-gray-400 hover:text-gray-500 rounded-full hover:bg-gray-50" title="å–æ¶ˆ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                `;

                btn.replaceWith(container);

                const input = container.querySelector('input');
                input.focus();

                const handleConfirm = () => confirmAddCustomNourishment(input.value);
                const handleCancel = () => renderNourishmentTags();

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };

                container.querySelector('#save-custom-nourishment').onclick = (e) => {
                    e.stopPropagation();
                    handleConfirm();
                };

                container.querySelector('#cancel-custom-nourishment').onclick = (e) => {
                    e.stopPropagation();
                    handleCancel();
                };
            }

            function confirmAddCustomNourishment(tag) {
                if (tag && tag.trim()) {
                    const cleanTag = tag.trim();
                    if (defaultNourishments.some(e => e.value === cleanTag) || customNourishments.includes(cleanTag)) {
                        alert('è¯¥æ´»åŠ¨å·²å­˜åœ¨ï¼');
                        return;
                    }

                    // Capture current selection before re-rendering
                    const selectedTags = Array.from(document.querySelectorAll('.nourishment-tag[aria-pressed="true"]')).map(el => el.dataset.tag);

                    customNourishments.push(cleanTag);
                    saveCustomNourishments();
                    renderNourishmentTags();

                    // Restore selection + Select new
                    selectedTags.push(cleanTag);

                    selectedTags.forEach(t => {
                        const el = document.querySelector(`.nourishment-tag[data-tag="${t}"]`);
                        if (el) {
                             el.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-800', 'ring-1', 'ring-blue-400');
                             el.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                             el.setAttribute('aria-pressed', 'true');
                        }
                    });
                } else {
                    renderNourishmentTags(); // Empty input, just cancel
                }
            }

            function openModal(dateStr) {
                selectedDate = dateStr;
                const data = userData[dateStr] || {};
                document.getElementById('modal-date').textContent = dateStr;
                
                // Reset mood
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400', 'ring-blue-400', 'bg-blue-50', 'selected', 'bg-opacity-100');
                    const span = btn.querySelector('span.filter');
                    if (span) span.classList.add('grayscale');
                });
                
                if (data.mood) {
                    const activeMood = document.querySelector(`.mood-btn[data-mood="${data.mood}"]`);
                    if (activeMood) {
                        activeMood.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-blue-50', 'selected');
                        const span = activeMood.querySelector('span.filter');
                        if (span) span.classList.remove('grayscale');
                    }
                }

                // Emotions Tags
                renderEmotionTags();
                document.querySelectorAll('.emotion-tag').forEach(tag => {
                    tag.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300', 'ring-1', 'ring-blue-300');
                    tag.classList.add('text-gray-600', 'border-gray-200');
                    tag.setAttribute('aria-pressed', 'false');
                });
                
                if (data.emotions && Array.isArray(data.emotions)) {
                    data.emotions.forEach(tagText => {
                        const tagEl = document.querySelector(`.emotion-tag[data-tag="${tagText}"]`);
                        if (tagEl) {
                            tagEl.classList.remove('text-gray-600', 'border-gray-200');
                            tagEl.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300', 'ring-1', 'ring-blue-300');
                            tagEl.setAttribute('aria-pressed', 'true');
                        }
                    });
                }

                document.getElementById('keywords-input').value = data.keywords ? data.keywords.join(', ') : '';
                document.getElementById('journal-input').value = data.journal || '';
                
                const xunPeriod = getXunPeriodByDateStr(dateStr);
                const xunIndex = xunPeriod ? xunPeriod.index : null;
                const xunGoalInput = document.getElementById('xun-goal-input');
                const xunGoalDisplay = document.getElementById('xun-goal-display');
                const xunGoalContainer = document.getElementById('xun-goal-container');
                // const xunGoalMeta = document.getElementById('xun-goal-meta'); // Removed
                // const goalCheckinInput = document.getElementById('goal-checkin-input'); // Removed
                // const goalConfidenceInput = document.getElementById('goal-confidence-input'); // Removed
                // const goalActionsInput = document.getElementById('goal-actions-input'); // Removed
                // const goalBlockersInput = document.getElementById('goal-blockers-input'); // Removed

                // if (xunGoalMeta) { ... } // Removed

                if (xunGoalInput) {
                    if (xunIndex) {
                        xunGoalInput.disabled = false;
                        const currentGoal = macroGoals[xunIndex]?.goal || '';
                        xunGoalInput.value = currentGoal;
                        if (xunGoalDisplay) xunGoalDisplay.textContent = currentGoal || 'ï¼ˆæœ¬æ—¬æœªè®¾ç½®æ ¸å¿ƒç›®æ ‡ï¼‰';
                        if (xunGoalContainer) xunGoalContainer.classList.remove('hidden');
                        
                        // We use input for storage but display for view in minimalist mode
                        // If we want to allow edit, we can add an edit button, but for now let's just use the inputs hidden logic or similar
                    } else {
                         if (xunGoalContainer) xunGoalContainer.classList.add('hidden');
                    }
                }

                const indicatorInput1 = document.getElementById('xun-indicator-1');
                const indicatorInput2 = document.getElementById('xun-indicator-2');
                const indicatorInput3 = document.getElementById('xun-indicator-3');
                const dayIndicatorLabel1 = document.getElementById('day-indicator-label-1');
                const dayIndicatorLabel2 = document.getElementById('day-indicator-label-2');
                const dayIndicatorLabel3 = document.getElementById('day-indicator-label-3');
                const dayIndicatorCheck1 = document.getElementById('day-indicator-check-1');
                const dayIndicatorCheck2 = document.getElementById('day-indicator-check-2');
                const dayIndicatorCheck3 = document.getElementById('day-indicator-check-3');
                const dayIndicatorRow1 = document.getElementById('day-indicator-row-1');
                const dayIndicatorRow2 = document.getElementById('day-indicator-row-2');
                const dayIndicatorRow3 = document.getElementById('day-indicator-row-3');

                const applyIndicatorState = () => {
                    const names = [
                        indicatorInput1 ? indicatorInput1.value.trim() : '',
                        indicatorInput2 ? indicatorInput2.value.trim() : '',
                        indicatorInput3 ? indicatorInput3.value.trim() : ''
                    ];

                    const setRow = (i, labelEl, checkEl, rowEl) => {
                        const name = names[i] || '';
                        if (labelEl) labelEl.textContent = name ? `ä»Šæ—¥æ‰“å¡ï¼š${name}` : `ä»Šæ—¥æ‰“å¡`;
                        if (checkEl) {
                            checkEl.disabled = !name;
                            if (!name) checkEl.checked = false;
                        }
                        if (rowEl) {
                            if (name) {
                                rowEl.classList.remove('hidden');
                            } else {
                                rowEl.classList.add('hidden');
                            }
                        }
                    };

                    setRow(0, dayIndicatorLabel1, dayIndicatorCheck1, dayIndicatorRow1);
                    setRow(1, dayIndicatorLabel2, dayIndicatorCheck2, dayIndicatorRow2);
                    setRow(2, dayIndicatorLabel3, dayIndicatorCheck3, dayIndicatorRow3);

                    if (xunIndex) {
                        if (!macroGoals[xunIndex]) macroGoals[xunIndex] = {};
                        macroGoals[xunIndex].indicators = names.filter(Boolean).slice(0, 3);
                        saveMacroGoals();
                        renderMacroView();
                        if (currentDetailPeriod) renderDetailView(currentDetailPeriod);
                        renderOverview();
                    }
                };

                if (indicatorInput1 && indicatorInput2 && indicatorInput3) {
                    if (xunIndex) {
                        const indicators = Array.isArray(macroGoals[xunIndex]?.indicators) ? macroGoals[xunIndex].indicators : [];
                        indicatorInput1.disabled = false;
                        indicatorInput2.disabled = false;
                        indicatorInput3.disabled = false;
                        indicatorInput1.value = indicators[0] || '';
                        indicatorInput2.value = indicators[1] || '';
                        indicatorInput3.value = indicators[2] || '';
                        indicatorInput1.oninput = applyIndicatorState;
                        indicatorInput2.oninput = applyIndicatorState;
                        indicatorInput3.oninput = applyIndicatorState;
                    } else {
                        indicatorInput1.disabled = true;
                        indicatorInput2.disabled = true;
                        indicatorInput3.disabled = true;
                        indicatorInput1.value = '';
                        indicatorInput2.value = '';
                        indicatorInput3.value = '';
                        indicatorInput1.oninput = null;
                        indicatorInput2.oninput = null;
                        indicatorInput3.oninput = null;
                    }
                }

                const checkins = Array.isArray(data.indicator_checkins) ? data.indicator_checkins : [];
                if (dayIndicatorCheck1) dayIndicatorCheck1.checked = checkins[0] === true;
                if (dayIndicatorCheck2) dayIndicatorCheck2.checked = checkins[1] === true;
                if (dayIndicatorCheck3) dayIndicatorCheck3.checked = checkins[2] === true;
                applyIndicatorState();

                // if (goalCheckinInput) goalCheckinInput.checked = data.goal_checkin === true;
                // if (goalConfidenceInput) goalConfidenceInput.value = Number.isFinite(data.goal_confidence) ? String(data.goal_confidence) : '';
                // if (goalActionsInput) goalActionsInput.value = Array.isArray(data.goal_actions) ? data.goal_actions.join(', ') : '';
                // if (goalBlockersInput) goalBlockersInput.value = data.goal_blockers || '';

                // Weather
                document.querySelectorAll('#weather-selector button').forEach(btn => btn.classList.remove('bg-gray-200'));
                if (data.weather) {
                    const btn = document.querySelector(`#weather-selector button[data-weather="${data.weather}"]`);
                    if (btn) btn.classList.add('bg-gray-200');
                }

                // Vitality (Energy)
                document.getElementById('energy-level').value = data.energy_level !== undefined ? data.energy_level : 50;

                // Nourishment Tags
                renderNourishmentTags();
                const savedTags = data.nourishment_tags || [];
                
                // Reset all first
                document.querySelectorAll('.nourishment-tag').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-800', 'ring-1', 'ring-blue-400');
                    btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                    btn.setAttribute('aria-pressed', 'false');
                });

                // Apply saved selection
                savedTags.forEach(tag => {
                    const btn = document.querySelector(`.nourishment-tag[data-tag="${tag}"]`);
                    if (btn) {
                        btn.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-800', 'ring-1', 'ring-blue-400');
                        btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                        btn.setAttribute('aria-pressed', 'true');
                    }
                });

                // Metrics
                const m = data.metrics || {};
                document.getElementById('metric-sleep').value = m.sleep || '';
                document.getElementById('metric-exercise').value = m.exercise || '';
                document.getElementById('metric-reading').value = m.reading || '';
                document.getElementById('metric-wealth').value = m.wealth || '';
                document.getElementById('metric-social').value = m.social || '';

                // Three Good Things
                const goodThings = data.three_good_things || [];
                document.getElementById('good-thing-1').value = goodThings[0] || '';
                document.getElementById('good-thing-2').value = goodThings[1] || '';
                document.getElementById('good-thing-3').value = goodThings[2] || '';

                // Custom activities
                const container = document.getElementById('custom-activities-container');
                container.querySelectorAll('.custom-activity-item').forEach(el => el.remove());
                if (data.custom_activities) {
                    data.custom_activities.forEach(act => addCustomActivityInput(act.name, act.value));
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function addCustomActivityInput(name = '', value = '') {
                const div = document.createElement('div');
                div.className = 'custom-activity-item flex items-center space-x-2';
                div.innerHTML = `
                    <input type="text" placeholder="æ´»åŠ¨åç§°" class="custom-name w-1/2 p-1 border rounded-md" value="${name}">
                    <input type="text" placeholder="å€¼" class="custom-value w-1/3 p-1 border rounded-md" value="${value}">
                    <button class="text-red-400 hover:text-red-600">&times;</button>
                `;
                div.querySelector('button').onclick = () => div.remove();
                document.getElementById('custom-activities-container').insertBefore(div, document.getElementById('add-custom-activity'));
            }

            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            function saveModalData() {
                const moodEl = document.querySelector('.mood-btn.ring-2');
                const weatherEl = document.querySelector('#weather-selector button.bg-gray-200');
                
                // Get selected emotions
                const selectedEmotions = Array.from(document.querySelectorAll('.emotion-tag.bg-blue-100'))
                    .map(el => el.dataset.tag);

                const xunGoalInput = document.getElementById('xun-goal-input'); // Added back for saving logic
                // const goalCheckinInput = document.getElementById('goal-checkin-input'); // Removed
                // const goalConfidenceInput = document.getElementById('goal-confidence-input'); // Removed
                // const goalActionsInput = document.getElementById('goal-actions-input'); // Removed
                // const goalBlockersInput = document.getElementById('goal-blockers-input'); // Removed
                const indicatorInput1 = document.getElementById('xun-indicator-1');
                const indicatorInput2 = document.getElementById('xun-indicator-2');
                const indicatorInput3 = document.getElementById('xun-indicator-3');
                const dayIndicatorCheck1 = document.getElementById('day-indicator-check-1');
                const dayIndicatorCheck2 = document.getElementById('day-indicator-check-2');
                const dayIndicatorCheck3 = document.getElementById('day-indicator-check-3');
                // const rawGoalConfidence = goalConfidenceInput ? parseInt(goalConfidenceInput.value, 10) : NaN;
                // const goalConfidence = Number.isFinite(rawGoalConfidence)
                //    ? Math.max(0, Math.min(100, rawGoalConfidence))
                //    : undefined;

                const xunPeriod = getXunPeriodByDateStr(selectedDate);
                const xunIndex = xunPeriod ? xunPeriod.index : null;

                // Save Goal if modified in modal (though it's hidden now, logic remains if we re-enable)
                if (xunIndex && xunGoalInput && xunGoalInput.value !== (macroGoals[xunIndex]?.goal || '')) {
                     if (!macroGoals[xunIndex]) macroGoals[xunIndex] = {};
                     macroGoals[xunIndex].goal = xunGoalInput.value;
                     saveMacroGoals();
                }

                const indicatorNames = [
                    indicatorInput1 ? indicatorInput1.value.trim() : '',
                    indicatorInput2 ? indicatorInput2.value.trim() : '',
                    indicatorInput3 ? indicatorInput3.value.trim() : ''
                ].filter(Boolean).slice(0, 3);

                if (xunIndex) {
                    if (!macroGoals[xunIndex]) macroGoals[xunIndex] = {};
                    macroGoals[xunIndex].indicators = indicatorNames;
                    saveMacroGoals();
                }

                const indicatorCheckins = [
                    dayIndicatorCheck1 ? dayIndicatorCheck1.checked : false,
                    dayIndicatorCheck2 ? dayIndicatorCheck2.checked : false,
                    dayIndicatorCheck3 ? dayIndicatorCheck3.checked : false
                ];

                userData[selectedDate] = {
                    mood: moodEl ? parseInt(moodEl.dataset.mood) : undefined,
                    emotions: selectedEmotions,
                    energy_level: parseInt(document.getElementById('energy-level').value) || 50,
                    nourishment_tags: Array.from(document.querySelectorAll('.nourishment-tag.bg-blue-100')).map(btn => btn.dataset.tag),
                    three_good_things: [
                        document.getElementById('good-thing-1').value,
                        document.getElementById('good-thing-2').value,
                        document.getElementById('good-thing-3').value
                    ].filter(Boolean),
                    // Keywords: allow 3 items, relax separator splitting to allow idioms?
                    // Actually, simple space/comma split is fine for "idioms" if they don't have spaces within.
                    // But English idioms have spaces.
                    // Let's use comma as primary separator if present, otherwise space?
                    // Or just let user manage it.
                    // User said: "not limited to 2 bytes or Chinese", "English words or idioms".
                    // Code below splits by space or comma. "Carpe Diem" would become "Carpe", "Diem".
                    // We should probably split by comma ONLY if user uses commas?
                    // Or maybe just use comma as separator?
                    // Let's stick to comma for idioms, or let user input freely.
                    // Let's try splitting by comma first.
                    keywords: document.getElementById('keywords-input').value.split(/[,ï¼Œ]/).map(k => k.trim()).filter(k => k.length > 0).slice(0, 3),
                    emoji: undefined, // Deprecated in favor of mood/keywords
                    weather: weatherEl ? weatherEl.dataset.weather : undefined,
                    journal: document.getElementById('journal-input').value,
                    // goal_checkin: goalCheckinInput ? goalCheckinInput.checked : undefined, // Removed
                    // goal_confidence: goalConfidence, // Removed
                    // goal_actions: goalActionsInput ? goalActionsInput.value.split(/[,ï¼Œ]/).map(k => k.trim()).filter(k => k.length > 0).slice(0, 3) : undefined, // Removed
                    // goal_blockers: goalBlockersInput ? (goalBlockersInput.value.trim() || undefined) : undefined, // Removed
                    indicator_checkins: indicatorCheckins,
                    metrics: {
                        sleep: parseFloat(document.getElementById('metric-sleep').value) || undefined,
                        exercise: parseInt(document.getElementById('metric-exercise').value) || undefined,
                        reading: parseInt(document.getElementById('metric-reading').value) || undefined,
                        wealth: parseFloat(document.getElementById('metric-wealth').value) || undefined,
                        social: document.getElementById('metric-social').value || undefined,
                    },
                    custom_activities: Array.from(document.querySelectorAll('.custom-activity-item')).map(item => ({
                        name: item.querySelector('.custom-name').value,
                        value: item.querySelector('.custom-value').value,
                    })).filter(i => i.name)
                };
                
                saveUserData();
                closeModal();
                if (currentDetailPeriod) renderDetailView(currentDetailPeriod);
                renderOverview();
                renderMacroView();
            }

            function deleteModalData() {
                if (confirm('ç¡®å®šåˆ é™¤æœ¬æ—¥æ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                    delete userData[selectedDate];
                    saveUserData();
                    closeModal();
                    if (currentDetailPeriod) renderDetailView(currentDetailPeriod);
                    renderOverview();
                    renderMacroView();
                }
            }

            function initScrollControls() {
                const backToTopContainer = document.getElementById('macro-back-to-top-container');
                const scrollDownContainer = document.getElementById('macro-scroll-down-container');
                const backToTopBtn = document.getElementById('macro-back-to-top');
                const scrollDownBtn = document.getElementById('macro-scroll-down');
                const macroView = document.getElementById('macro-view');

                if (backToTopBtn && scrollDownBtn && backToTopContainer && scrollDownContainer) {
                    const handleScroll = () => {
                        // 1. Check if we are in Macro View
                        const isMacroView = !macroView.classList.contains('hidden');
                        
                        if (!isMacroView) {
                            // Hide both if not in macro view
                            backToTopContainer.classList.add('opacity-0', 'pointer-events-none');
                            scrollDownContainer.classList.add('opacity-0', 'pointer-events-none');
                            backToTopContainer.setAttribute('aria-hidden', 'true');
                            scrollDownContainer.setAttribute('aria-hidden', 'true');
                            backToTopBtn.tabIndex = -1;
                            scrollDownBtn.tabIndex = -1;
                            return;
                        }

                        // 2. We are in Macro View
                        // Scroll Down button always visible
                        scrollDownContainer.classList.remove('opacity-0', 'pointer-events-none');
                        scrollDownContainer.setAttribute('aria-hidden', 'false');
                        scrollDownBtn.tabIndex = 0;

                        // 3. Back to Top Logic
                        if (window.scrollY > 300) {
                            backToTopContainer.classList.remove('opacity-0', 'pointer-events-none');
                            backToTopContainer.setAttribute('aria-hidden', 'false');
                            backToTopBtn.tabIndex = 0;
                        } else {
                            backToTopContainer.classList.add('opacity-0', 'pointer-events-none');
                            backToTopContainer.setAttribute('aria-hidden', 'true');
                            backToTopBtn.tabIndex = -1;
                        }
                    };
                    
                    // Add listeners for view changes
                    const observer = new MutationObserver(handleScroll);
                    observer.observe(macroView, { attributes: true, attributeFilter: ['class'] });
                    window.addEventListener('scroll', handleScroll);
                    
                    // Initial check
                    handleScroll();

                    backToTopBtn.addEventListener('click', () => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    
                    scrollDownBtn.addEventListener('click', () => {
                        // Find next xun row
                        const rows = Array.from(document.querySelectorAll('[id^="xun-row-"]'));
                        // Current center line
                        const centerLine = window.scrollY + (window.innerHeight / 2);
                        
                        // Find the first row that is below the center line
                        let nextRow = rows.find(row => {
                            const rect = row.getBoundingClientRect();
                            // rect.top is relative to viewport
                            return rect.top > (window.innerHeight * 0.6); 
                        });
                        
                        if (nextRow) {
                            nextRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                             // If no next row, scroll to bottom
                             window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                        }
                    });
                }
            }

            // --- Theme Management ---
            const themeBtn = document.getElementById('theme-btn');
            const themeMenu = document.getElementById('theme-menu');
            
            if (themeBtn && themeMenu) {
                themeBtn.onclick = (e) => {
                    e.stopPropagation();
                    themeMenu.classList.toggle('hidden');
                };

                document.addEventListener('click', (e) => {
                    if (!themeMenu.contains(e.target) && !themeBtn.contains(e.target)) {
                        themeMenu.classList.add('hidden');
                    }
                });
            }

            window.setTheme = function(theme) {
                document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
                
                // Keep base classes
                if (!document.body.classList.contains('bg-gray-50')) document.body.classList.add('bg-gray-50');
                if (!document.body.classList.contains('text-gray-800')) document.body.classList.add('text-gray-800');
                if (!document.body.classList.contains('antialiased')) document.body.classList.add('antialiased');
                if (!document.body.classList.contains('overflow-x-hidden')) document.body.classList.add('overflow-x-hidden');

                if (theme !== 'default') {
                    document.body.classList.add(`theme-${theme}`);
                }
                
                localStorage.setItem('user_theme', theme);
                if (themeMenu) themeMenu.classList.add('hidden');
            };

            // Load saved theme
            const savedTheme = localStorage.getItem('user_theme');
            if (savedTheme) {
                setTheme(savedTheme);
            }

            // --- Initialization ---
            function init() {
                xunPeriods = getXunPeriods(YEAR);
                currentXun = getCurrentXun(xunPeriods);
                document.getElementById('current-xun-info').textContent = currentXun ? `å½“å‰æ˜¯ç¬¬ ${currentXun.index} æ—¬` : `å½“å‰ä¸åœ¨ ${YEAR} å¹´èŒƒå›´å†…`;
                
                // Set default view to Macro
                showView('macro');
                window.openModal = openModal;
                window.closeModal = closeModal;

                // Events
                document.getElementById('nav-macro').onclick = () => showView('macro');
                document.getElementById('nav-overview').onclick = () => showView('overview');
                
                const backToOverviewBtn = document.getElementById('back-to-overview');
                if (backToOverviewBtn) backToOverviewBtn.onclick = () => showView('overview');

                const showSummaryBtn = document.getElementById('show-summary-btn');
                if (showSummaryBtn) showSummaryBtn.onclick = () => showView('summary', currentDetailPeriod);

                const backToDetailBtn = document.getElementById('back-to-detail');
                if (backToDetailBtn) backToDetailBtn.onclick = () => showView('detail', currentDetailPeriod);

                document.getElementById('modal-close').onclick = closeModal;
                document.getElementById('modal-save').onclick = saveModalData;
                document.getElementById('modal-delete').onclick = deleteModalData;
                document.getElementById('add-custom-activity').onclick = () => addCustomActivityInput();

                document.getElementById('mood-selector').onclick = (e) => {
                    const btn = e.target.closest('.mood-btn');
                    if (btn && btn.dataset.mood) {
                        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400'));
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
                    }
                };

                // Emotion Tags Listener
                const moodSelector = document.getElementById('mood-selector');
                if (moodSelector) {
                    moodSelector.onclick = (e) => {
                        const btn = e.target.closest('.mood-btn');
                        if (btn) {
                             // Reset all
                             document.querySelectorAll('.mood-btn').forEach(b => {
                                 b.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-blue-50', 'selected');
                                 // Reset grayscale for all
                                 const span = b.querySelector('span.filter');
                                 if (span) span.classList.add('grayscale');
                             });
                             
                             // Activate current
                             btn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-blue-50', 'selected');
                             // Remove grayscale
                             const span = btn.querySelector('span.filter');
                             if (span) span.classList.remove('grayscale');
                        }
                    };
                }

                const emotionTagsContainer = document.getElementById('emotion-tags');
                if (emotionTagsContainer) {
                    emotionTagsContainer.onclick = (e) => {
                        // Handle Custom Button
                        if (e.target.closest('#add-custom-emotion-btn')) {
                            addCustomEmotion();
                            return;
                        }

                        const btn = e.target.closest('.emotion-tag');
                        if (btn) {
                            // Toggle active class
                            const isPressed = btn.getAttribute('aria-pressed') === 'true';
                            if (isPressed) {
                                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300', 'ring-1', 'ring-blue-300');
                                btn.classList.add('text-gray-600', 'border-gray-200');
                                btn.setAttribute('aria-pressed', 'false');
                            } else {
                                btn.classList.remove('text-gray-600', 'border-gray-200');
                                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300', 'ring-1', 'ring-blue-300');
                                btn.setAttribute('aria-pressed', 'true');
                            }
                        }
                    };
                }

                // Nourishment Tags Listener (New)
                const nourishmentContainer = document.getElementById('nourishment-tags-container');
                if (nourishmentContainer) {
                    nourishmentContainer.onclick = (e) => {
                        // Handle Custom Button
                        if (e.target.closest('#add-custom-nourishment-btn')) {
                            addCustomNourishment();
                            return;
                        }

                        const btn = e.target.closest('.nourishment-tag');
                        if (btn) {
                            // Toggle state
                            const isPressed = btn.getAttribute('aria-pressed') === 'true';
                            if (isPressed) {
                                // Unselect
                                btn.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-800', 'ring-1', 'ring-blue-400');
                                btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                                btn.setAttribute('aria-pressed', 'false');
                            } else {
                                // Select
                                btn.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-800', 'ring-1', 'ring-blue-400');
                                btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                                btn.setAttribute('aria-pressed', 'true');
                            }
                        }
                    };
                }
                
                document.getElementById('weather-selector').onclick = (e) => {
                    const btn = e.target.closest('button');
                    if (btn && btn.dataset.weather) {
                        document.querySelectorAll('#weather-selector button').forEach(b => b.classList.remove('bg-gray-200'));
                        btn.classList.add('bg-gray-200');
                    }
                };

                // Initialize Quote System
                if (typeof QuoteSystem !== 'undefined') {
                    QuoteSystem.init();
                }

                window.onclick = (e) => {
                    if (e.target === modal) closeModal();
                };

                updateYearProgress();
                renderYearPixelGrid();
                initScrollControls();
            }




            function updateYearProgress() {
                const now = new Date();
                const start = new Date(YEAR, 0, 1);
                const end = new Date(YEAR, 11, 31);
                
                let current = now;
                if (current.getFullYear() < YEAR) current = new Date(YEAR, 0, 1);
                if (current.getFullYear() > YEAR) current = new Date(YEAR, 11, 31);
                
                const total = end - start;
                const progress = current - start;
                const percentage = Math.max(0, Math.min(100, (progress / total) * 100));
                
                const dayOfYear = Math.floor((current - start) / (1000 * 60 * 60 * 24)) + 1;
                
                const totalDays = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const remainingDays = totalDays - dayOfYear;
                
                const progressBar = document.getElementById('year-progress-bar');
                const progressWalker = document.getElementById('year-progress-walker');
                const progressText = document.getElementById('year-progress-text');
                
                if (progressBar) progressBar.style.width = `${percentage}%`;
                if (progressWalker) progressWalker.style.left = `${percentage}%`;
                if (progressText) progressText.textContent = `å·²è¿‡ ${dayOfYear} å¤© Â· å‰©ä½™ ${remainingDays} å¤© Â· ${percentage.toFixed(1)}%`;

                const walker = document.getElementById('year-progress-walker');
                const bubble = document.getElementById('walker-bubble');
                if (walker && bubble) {
                    walker.addEventListener('mouseenter', () => bubble.classList.remove('opacity-0'));
                    walker.addEventListener('mouseleave', () => bubble.classList.add('opacity-0'));
                }
            }

            function renderYearPixelGrid() {
                const container = document.getElementById('year-pixel-grid');
                const wrapper = document.getElementById('year-pixel-grid-container');
                if (!container || !wrapper) return;
                
                wrapper.classList.remove('hidden');
                container.innerHTML = '';

                const now = new Date();
                const todayStart = new Date(now);
                todayStart.setHours(0, 0, 0, 0);
                const start = new Date(YEAR, 0, 1);
                const end = new Date(YEAR, 11, 31);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatLocalDate(d);
                    const cellStart = new Date(d);
                    cellStart.setHours(0, 0, 0, 0);
                    const isToday = cellStart.getTime() === todayStart.getTime();
                    const isPast = cellStart.getTime() < todayStart.getTime();
                    const isFuture = cellStart.getTime() > todayStart.getTime();
                    
                    const cell = document.createElement('div');
                    let className = "w-2.5 h-2.5 rounded-[1px] transition-all duration-300 ";

                    if (isToday) {
                        className += "shadow-md scale-110 z-10 animate-pulse border border-black/10";
                        cell.style.backgroundColor = `#2563EB`;
                        cell.title = `${dateStr}ï¼ˆä»Šå¤©ï¼‰`;
                    } else if (isPast) {
                        cell.style.backgroundColor = `#DBEAFE`;
                        className += "opacity-90 hover:opacity-100";
                        cell.title = `${dateStr}ï¼ˆè¿‡å»ï¼‰`;
                    } else {
                        cell.style.backgroundColor = `#F3F4F6`;
                        className += "hover:bg-gray-200";
                        cell.title = `${dateStr}ï¼ˆæœªæ¥ï¼‰`;
                    }
                    
                    cell.className = className;
                    container.appendChild(cell);
                }
            }

            init();
        });
    </script>
</body>
</html>
